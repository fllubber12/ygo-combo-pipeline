

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.ygo_combo.engine.state &mdash; YGO-Combo-Pipeline 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            YGO-Combo-Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/types.html">Shared Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/engine.html">Engine Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/search.html">Search Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/cards.html">Cards Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/encoding.html">Encoding Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/enumeration.html">Enumeration Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules/combo_enumeration.html">Combo Enumeration</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">YGO-Combo-Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.ygo_combo.engine.state</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.ygo_combo.engine.state</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Canonical state representation for combo enumeration.</span>

<span class="sd">Three abstraction levels:</span>
<span class="sd">1. BoardSignature - For terminal board evaluation (zone-agnostic)</span>
<span class="sd">2. IntermediateState - For path pruning (includes OPT via legal actions)</span>
<span class="sd">3. ActionSpec - Standardized action representation (ygo-agent style)</span>

<span class="sd">Design decisions (based on analysis):</span>
<span class="sd">- Use passcodes, not instance IDs (copies are fungible)</span>
<span class="sd">- Zone-agnostic for board quality evaluation</span>
<span class="sd">- Include legal actions for OPT capture</span>
<span class="sd">- Include equip relationships (important for Fiendsmith)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">FrozenSet</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>

<span class="c1"># Import location and query constants from canonical source</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.bindings</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">LOCATION_DECK</span><span class="p">,</span> <span class="n">LOCATION_HAND</span><span class="p">,</span> <span class="n">LOCATION_MZONE</span><span class="p">,</span> <span class="n">LOCATION_SZONE</span><span class="p">,</span>
    <span class="n">LOCATION_GRAVE</span><span class="p">,</span> <span class="n">LOCATION_REMOVED</span><span class="p">,</span> <span class="n">LOCATION_EXTRA</span><span class="p">,</span>
    <span class="n">QUERY_CODE</span><span class="p">,</span> <span class="n">QUERY_POSITION</span><span class="p">,</span> <span class="n">QUERY_EQUIP_CARD</span><span class="p">,</span> <span class="n">QUERY_END</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="BoardSignature">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.BoardSignature">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BoardSignature</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Terminal board state for evaluation.</span>
<span class="sd">    Zone-agnostic: only cares WHAT cards are where, not exact positions.</span>

<span class="sd">    Used for:</span>
<span class="sd">    - Detecting duplicate terminal boards</span>
<span class="sd">    - Board quality scoring</span>
<span class="sd">    - Combo categorization</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">monsters</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>      <span class="c1"># Passcodes on monster zones</span>
    <span class="n">spells</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>        <span class="c1"># Passcodes on spell/trap zones</span>
    <span class="n">graveyard</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>     <span class="c1"># Passcodes in GY</span>
    <span class="n">hand</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>          <span class="c1"># Passcodes in hand</span>
    <span class="n">banished</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>      <span class="c1"># Passcodes banished</span>
    <span class="n">extra_deck</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>    <span class="c1"># Passcodes remaining in extra (optional)</span>
    <span class="n">equips</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>  <span class="c1"># (equipped_passcode, target_passcode)</span>

<div class="viewcode-block" id="BoardSignature.hash">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.BoardSignature.hash">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deterministic hash for board comparison.</span>

<span class="sd">        Note: For new code, prefer zobrist_hash() which returns int</span>
<span class="sd">        and supports O(1) incremental updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Exclude extra_deck from hash (usually irrelevant for evaluation)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monsters</span><span class="p">)),</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spells</span><span class="p">)),</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graveyard</span><span class="p">)),</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hand</span><span class="p">)),</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">banished</span><span class="p">)),</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equips</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span></div>


<div class="viewcode-block" id="BoardSignature.zobrist_hash">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.BoardSignature.zobrist_hash">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">zobrist_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Zobrist hash for this board signature.</span>

<span class="sd">        Returns 64-bit integer hash. Use this instead of hash() for</span>
<span class="sd">        transposition table lookups - supports O(1) incremental updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">utils.hashing</span><span class="w"> </span><span class="kn">import</span> <span class="n">zobrist_hash</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..utils.hashing</span><span class="w"> </span><span class="kn">import</span> <span class="n">zobrist_hash</span>
        <span class="k">return</span> <span class="n">zobrist_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="BoardSignature.to_dict">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.BoardSignature.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serializable representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;monsters&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monsters</span><span class="p">),</span>
            <span class="s2">&quot;spells&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spells</span><span class="p">),</span>
            <span class="s2">&quot;graveyard&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graveyard</span><span class="p">),</span>
            <span class="s2">&quot;hand&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hand</span><span class="p">),</span>
            <span class="s2">&quot;banished&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">banished</span><span class="p">),</span>
            <span class="s2">&quot;extra_deck&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_deck</span><span class="p">),</span>
            <span class="s2">&quot;equips&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equips</span><span class="p">)],</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="BoardSignature.from_dict">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.BoardSignature.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BoardSignature&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstruct from serialized dict.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">monsters</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;monsters&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">spells</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spells&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">graveyard</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;graveyard&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">hand</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hand&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">banished</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;banished&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">extra_deck</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extra_deck&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">equips</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;equips&quot;</span><span class="p">,</span> <span class="p">[])),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BoardSignature.from_board_state">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.BoardSignature.from_board_state">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_board_state</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">board_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BoardSignature&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert existing board_state dict to BoardSignature.&quot;&quot;&quot;</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">board_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;player0&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">extract_codes</span><span class="p">(</span><span class="n">cards</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
            <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cards</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">))</span>

        <span class="c1"># Extract equip relationships</span>
        <span class="n">equips</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spells&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">equip_target</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;equip_target&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">equip_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">equip_target</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">equipped_code</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="c1"># Find target monster code by zone index</span>
                <span class="k">for</span> <span class="n">monster</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;monsters&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">monster</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;zone_index&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">equip_target</span><span class="p">:</span>
                        <span class="n">target_code</span> <span class="o">=</span> <span class="n">monster</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">equips</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">equipped_code</span><span class="p">,</span> <span class="n">target_code</span><span class="p">))</span>
                        <span class="k">break</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">monsters</span><span class="o">=</span><span class="n">extract_codes</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;monsters&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">spells</span><span class="o">=</span><span class="n">extract_codes</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spells&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">graveyard</span><span class="o">=</span><span class="n">extract_codes</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;graveyard&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">hand</span><span class="o">=</span><span class="n">extract_codes</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hand&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">banished</span><span class="o">=</span><span class="n">extract_codes</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;banished&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">extra_deck</span><span class="o">=</span><span class="n">extract_codes</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extra&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="n">equips</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">equips</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BoardSignature.from_engine">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.BoardSignature.from_engine">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_engine</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">capture_func</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BoardSignature&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Capture board signature directly from engine.</span>

<span class="sd">        Args:</span>
<span class="sd">            lib: OCG library handle</span>
<span class="sd">            duel: Duel pointer</span>
<span class="sd">            capture_func: Function to capture board state (lib, duel) -&gt; dict</span>
<span class="sd">                         Required to avoid circular imports.</span>

<span class="sd">        Returns:</span>
<span class="sd">            BoardSignature for current board state</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If capture_func is None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">capture_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;capture_func is required to avoid circular imports&quot;</span><span class="p">)</span>

        <span class="n">board_state</span> <span class="o">=</span> <span class="n">capture_func</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">duel</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_board_state</span><span class="p">(</span><span class="n">board_state</span><span class="p">)</span></div>


<div class="viewcode-block" id="BoardSignature.monster_count">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.BoardSignature.monster_count">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">monster_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monsters</span><span class="p">)</span></div>


<div class="viewcode-block" id="BoardSignature.total_cards_on_field">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.BoardSignature.total_cards_on_field">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_cards_on_field</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monsters</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spells</span><span class="p">)</span></div>


<div class="viewcode-block" id="BoardSignature.has_boss">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.BoardSignature.has_boss">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_boss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boss_codes</span><span class="p">:</span> <span class="nb">set</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if any boss monster is on field.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monsters</span> <span class="o">&amp;</span> <span class="n">boss_codes</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ActionSpec">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.ActionSpec">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ActionSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standardized action specification (inspired by ygo-agent).</span>

<span class="sd">    Spec string format:</span>
<span class="sd">    - &quot;act:CODE:EFFECT&quot; = Activate card with passcode CODE, effect index EFFECT</span>
<span class="sd">    - &quot;ss:CODE&quot;         = Special summon card CODE</span>
<span class="sd">    - &quot;ns:CODE&quot;         = Normal summon card CODE</span>
<span class="sd">    - &quot;mset:CODE&quot;       = Monster set CODE</span>
<span class="sd">    - &quot;sset:CODE&quot;       = Spell/trap set CODE</span>
<span class="sd">    - &quot;pass&quot;            = End phase / pass</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">passcode</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">action_type</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># &quot;activate&quot;, &quot;summon&quot;, &quot;spsummon&quot;, &quot;mset&quot;, &quot;sset&quot;, &quot;pass&quot;</span>
    <span class="n">effect_index</span><span class="p">:</span> <span class="nb">int</span>     <span class="c1"># Which effect (-1 if N/A)</span>
    <span class="n">location</span><span class="p">:</span> <span class="nb">int</span>         <span class="c1"># Card location (HAND, MZONE, etc.)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ActionSpec</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">spec</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="ActionSpec.activate">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.ActionSpec.activate">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">activate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">effect_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ActionSpec&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an activate action spec.&quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;act:</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">effect_idx</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">passcode</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;activate&quot;</span><span class="p">,</span>
                   <span class="n">effect_index</span><span class="o">=</span><span class="n">effect_idx</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span></div>


<div class="viewcode-block" id="ActionSpec.special_summon">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.ActionSpec.special_summon">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">special_summon</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ActionSpec&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a special summon action spec.&quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ss:</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">passcode</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;spsummon&quot;</span><span class="p">,</span>
                   <span class="n">effect_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">LOCATION_EXTRA</span><span class="p">)</span></div>


<div class="viewcode-block" id="ActionSpec.normal_summon">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.ActionSpec.normal_summon">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">normal_summon</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ActionSpec&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a normal summon action spec.&quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ns:</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">passcode</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;summon&quot;</span><span class="p">,</span>
                   <span class="n">effect_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">LOCATION_HAND</span><span class="p">)</span></div>


<div class="viewcode-block" id="ActionSpec.monster_set">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.ActionSpec.monster_set">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">monster_set</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ActionSpec&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a monster set action spec.&quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mset:</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">passcode</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;mset&quot;</span><span class="p">,</span>
                   <span class="n">effect_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">LOCATION_HAND</span><span class="p">)</span></div>


<div class="viewcode-block" id="ActionSpec.spell_set">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.ActionSpec.spell_set">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">spell_set</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ActionSpec&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a spell/trap set action spec.&quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sset:</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">passcode</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;sset&quot;</span><span class="p">,</span>
                   <span class="n">effect_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">LOCATION_HAND</span><span class="p">)</span></div>


<div class="viewcode-block" id="ActionSpec.pass_action">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.ActionSpec.pass_action">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pass_action</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ActionSpec&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a pass/end phase action spec.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="s2">&quot;pass&quot;</span><span class="p">,</span> <span class="n">passcode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;pass&quot;</span><span class="p">,</span>
                   <span class="n">effect_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="IntermediateState">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.IntermediateState">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">IntermediateState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Full intermediate state for path pruning.</span>

<span class="sd">    Includes board + legal actions, which captures:</span>
<span class="sd">    - Card positions</span>
<span class="sd">    - OPT usage (via what&#39;s still activatable)</span>
<span class="sd">    - Summon restrictions</span>
<span class="sd">    - Any other hidden state the engine tracks</span>

<span class="sd">    Two states with identical IntermediateState.hash() will have</span>
<span class="sd">    identical future action spaces, so we only need to explore one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">board</span><span class="p">:</span> <span class="n">BoardSignature</span>
    <span class="n">legal_actions</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>  <span class="c1"># Just spec strings for efficient hashing</span>

<div class="viewcode-block" id="IntermediateState.hash">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.IntermediateState.hash">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deterministic hash including OPT state.</span>

<span class="sd">        Note: For new code, prefer zobrist_hash() which returns int</span>
<span class="sd">        and supports O(1) incremental updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action_part</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legal_actions</span><span class="p">))</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">hash</span><span class="p">(),</span> <span class="n">action_part</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">24</span><span class="p">]</span></div>


<div class="viewcode-block" id="IntermediateState.zobrist_hash">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.IntermediateState.zobrist_hash">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">zobrist_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Zobrist hash including legal actions (OPT state).</span>

<span class="sd">        Returns 64-bit integer hash.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">utils.hashing</span><span class="w"> </span><span class="kn">import</span> <span class="n">zobrist_hash_intermediate</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">..utils.hashing</span><span class="w"> </span><span class="kn">import</span> <span class="n">zobrist_hash_intermediate</span>
        <span class="k">return</span> <span class="n">zobrist_hash_intermediate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntermediateState.to_dict">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.IntermediateState.to_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serializable representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;board&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s2">&quot;legal_actions&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legal_actions</span><span class="p">),</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="IntermediateState.from_idle_data">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.IntermediateState.from_idle_data">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_idle_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">idle_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">board_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntermediateState&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract intermediate state from engine idle data + board state.</span>

<span class="sd">        Args:</span>
<span class="sd">            idle_data: Parsed MSG_IDLE data</span>
<span class="sd">            board_state: Current board state dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">board</span> <span class="o">=</span> <span class="n">BoardSignature</span><span class="o">.</span><span class="n">from_board_state</span><span class="p">(</span><span class="n">board_state</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_extract_action_specs</span><span class="p">(</span><span class="n">idle_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">board</span><span class="o">=</span><span class="n">board</span><span class="p">,</span> <span class="n">legal_actions</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">spec</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">))</span></div>


<div class="viewcode-block" id="IntermediateState.from_engine">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.IntermediateState.from_engine">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_engine</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">idle_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">capture_func</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;IntermediateState&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract intermediate state directly from engine.</span>

<span class="sd">        Convenience method that captures board state and creates IntermediateState.</span>

<span class="sd">        Args:</span>
<span class="sd">            lib: OCG library handle</span>
<span class="sd">            duel: Duel pointer</span>
<span class="sd">            idle_data: Parsed MSG_IDLE data</span>
<span class="sd">            capture_func: Function to capture board state (lib, duel) -&gt; dict</span>
<span class="sd">                         Required to avoid circular imports.</span>

<span class="sd">        Returns:</span>
<span class="sd">            IntermediateState with current board and legal actions</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If capture_func is None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">capture_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;capture_func is required to avoid circular imports&quot;</span><span class="p">)</span>

        <span class="n">board_state</span> <span class="o">=</span> <span class="n">capture_func</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">duel</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_idle_data</span><span class="p">(</span><span class="n">idle_data</span><span class="p">,</span> <span class="n">board_state</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_action_specs</span><span class="p">(</span><span class="n">idle_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ActionSpec</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert MSG_IDLE to ActionSpec list.&quot;&quot;&quot;</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Activatable effects</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;activatable&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">effect_idx</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">&amp;</span> <span class="mh">0xF</span> <span class="k">if</span> <span class="n">desc</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActionSpec</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">effect_idx</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span>

        <span class="c1"># Special summons</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spsummon&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActionSpec</span><span class="o">.</span><span class="n">special_summon</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>

        <span class="c1"># Normal summons</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summonable&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActionSpec</span><span class="o">.</span><span class="n">normal_summon</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>

        <span class="c1"># Monster sets</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mset&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActionSpec</span><span class="o">.</span><span class="n">monster_set</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>

        <span class="c1"># Spell/trap sets</span>
        <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sset&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActionSpec</span><span class="o">.</span><span class="n">spell_set</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>

        <span class="c1"># Pass option</span>
        <span class="k">if</span> <span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;to_ep&quot;</span><span class="p">):</span>
            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActionSpec</span><span class="o">.</span><span class="n">pass_action</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">specs</span>

<div class="viewcode-block" id="IntermediateState.num_actions">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.IntermediateState.num_actions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legal_actions</span><span class="p">)</span></div>


<div class="viewcode-block" id="IntermediateState.can_pass">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.IntermediateState.can_pass">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;pass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">legal_actions</span></div>
</div>



<span class="c1"># =============================================================================</span>
<span class="c1"># BOARD EVALUATION CONFIGURATION</span>
<span class="c1"># =============================================================================</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Load evaluation config from file</span>
<span class="n">_EVALUATION_CONFIG</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_load_evaluation_config</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load evaluation configuration from config file.</span>

<span class="sd">    Raises FileNotFoundError if config is missing - no fallback defaults</span>
<span class="sd">    to prevent stale/hallucinated card data from being used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_EVALUATION_CONFIG</span>
    <span class="k">if</span> <span class="n">_EVALUATION_CONFIG</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_EVALUATION_CONFIG</span>

    <span class="n">config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;config&quot;</span> <span class="o">/</span> <span class="s2">&quot;evaluation_config.json&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;evaluation_config.json not found at </span><span class="si">{</span><span class="n">config_path</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This file is required - do not use hardcoded card IDs. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;All card data must be verified against cards.cdb.&quot;</span>
        <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">_EVALUATION_CONFIG</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_EVALUATION_CONFIG</span>


<div class="viewcode-block" id="get_boss_monsters">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.get_boss_monsters">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_boss_monsters</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the set of boss monster passcodes.&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">_load_evaluation_config</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boss_monsters&quot;</span><span class="p">,</span> <span class="p">[]))</span></div>



<div class="viewcode-block" id="get_interaction_pieces">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.get_interaction_pieces">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_interaction_pieces</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the set of interaction piece passcodes.&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">_load_evaluation_config</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interaction_pieces&quot;</span><span class="p">,</span> <span class="p">[]))</span></div>



<div class="viewcode-block" id="get_fiendsmith_gy_targets">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.get_fiendsmith_gy_targets">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_fiendsmith_gy_targets</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the set of Fiendsmith GY target passcodes.&quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">_load_evaluation_config</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fiendsmith_gy_targets&quot;</span><span class="p">,</span> <span class="p">[]))</span></div>



<span class="c1"># Legacy exports for backward compatibility</span>
<span class="n">BOSS_MONSTERS</span> <span class="o">=</span> <span class="n">get_boss_monsters</span><span class="p">()</span>
<span class="n">INTERACTION_PIECES</span> <span class="o">=</span> <span class="n">get_interaction_pieces</span><span class="p">()</span>


<div class="viewcode-block" id="evaluate_board_quality">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.evaluate_board_quality">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_board_quality</span><span class="p">(</span><span class="n">sig</span><span class="p">:</span> <span class="n">BoardSignature</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate board quality for combo scoring.</span>

<span class="sd">    Configuration loaded from config/evaluation_config.json.</span>

<span class="sd">    Returns dict with:</span>
<span class="sd">    - tier: S/A/B/C/brick</span>
<span class="sd">    - score: numeric score</span>
<span class="sd">    - details: explanation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">_load_evaluation_config</span><span class="p">()</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score_weights&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">thresholds</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tier_thresholds&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>

    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">boss_monsters</span> <span class="o">=</span> <span class="n">get_boss_monsters</span><span class="p">()</span>
    <span class="n">interaction_pieces</span> <span class="o">=</span> <span class="n">get_interaction_pieces</span><span class="p">()</span>
    <span class="n">fiendsmith_gy</span> <span class="o">=</span> <span class="n">get_fiendsmith_gy_targets</span><span class="p">()</span>

    <span class="c1"># Check for boss monsters</span>
    <span class="n">bosses_on_field</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">monsters</span> <span class="o">&amp;</span> <span class="n">boss_monsters</span>
    <span class="k">if</span> <span class="n">bosses_on_field</span><span class="p">:</span>
        <span class="n">boss_weight</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boss_monster&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">boss_weight</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bosses_on_field</span><span class="p">)</span>
        <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boss monsters: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bosses_on_field</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Check for interaction pieces</span>
    <span class="n">interaction</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">monsters</span> <span class="o">&amp;</span> <span class="n">interaction_pieces</span>
    <span class="k">if</span> <span class="n">interaction</span><span class="p">:</span>
        <span class="n">interaction_weight</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interaction_piece&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">interaction_weight</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span>
        <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interaction pieces: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Check for equipped Link monsters (Fiendsmith combo indicator)</span>
    <span class="k">if</span> <span class="n">sig</span><span class="o">.</span><span class="n">equips</span><span class="p">:</span>
        <span class="n">equip_weight</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;equipped_link&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">equip_weight</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">equips</span><span class="p">)</span>
        <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Equipped Links: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">equips</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Monster count</span>
    <span class="n">monster_weight</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;monster_on_field&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">+=</span> <span class="n">monster_weight</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">monsters</span><span class="p">)</span>

    <span class="c1"># Graveyard setup (Fiendsmith likes GY)</span>
    <span class="n">fiendsmith_in_gy</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">graveyard</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fiendsmith_gy</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">fiendsmith_in_gy</span><span class="p">:</span>
        <span class="n">gy_weight</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fiendsmith_in_gy&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">+=</span> <span class="n">gy_weight</span> <span class="o">*</span> <span class="n">fiendsmith_in_gy</span>
        <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fiendsmith pieces in GY: </span><span class="si">{</span><span class="n">fiendsmith_in_gy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Determine tier</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
        <span class="n">tier</span> <span class="o">=</span> <span class="s2">&quot;S&quot;</span>
    <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="mi">70</span><span class="p">):</span>
        <span class="n">tier</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
    <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="mi">40</span><span class="p">):</span>
        <span class="n">tier</span> <span class="o">=</span> <span class="s2">&quot;B&quot;</span>
    <span class="k">elif</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
        <span class="n">tier</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tier</span> <span class="o">=</span> <span class="s2">&quot;brick&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;tier&quot;</span><span class="p">:</span> <span class="n">tier</span><span class="p">,</span>
        <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
        <span class="s2">&quot;monsters_on_field&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">monsters</span><span class="p">),</span>
        <span class="s2">&quot;has_boss&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bosses_on_field</span><span class="p">),</span>
        <span class="s2">&quot;has_interaction&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">interaction</span><span class="p">),</span>
        <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
    <span class="p">}</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1"># SIMPLE ENDBOARD EVALUATION</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="evaluate_endboard">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.evaluate_endboard">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluate_endboard</span><span class="p">(</span><span class="n">board_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple additive scoring for terminal board evaluation.</span>

<span class="sd">    Works directly with board_state dict (legacy format).</span>
<span class="sd">    Higher score = better endboard.</span>

<span class="sd">    Scoring:</span>
<span class="sd">    - D/D/D Wave High King Caesar: 100 pts</span>
<span class="sd">    - Fiendsmith Desirae (equipped): 100 pts</span>
<span class="sd">    - Fiendsmith Desirae (no equip): 40 pts</span>
<span class="sd">    - Fiendsmith Sequence: 50 pts</span>
<span class="sd">    - Other Fiendsmith Link: 30 pts</span>
<span class="sd">    - Other monster: 10 pts</span>
<span class="sd">    - Fiendsmith in GY: 10 pts each</span>
<span class="sd">    - Card in hand: 5 pts each</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">board_state</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">board_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;player0&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Field monsters</span>
    <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;monsters&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;D/D/D Wave High King Caesar&quot;</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">100</span>
        <span class="k">elif</span> <span class="s2">&quot;Desirae&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="c1"># Check for equip (ATK &gt; base or equip cards present)</span>
            <span class="n">atk</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;atk&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">atk</span> <span class="o">&gt;</span> <span class="mi">2500</span><span class="p">:</span>  <span class="c1"># Has ATK boost from equip</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">40</span>
        <span class="k">elif</span> <span class="s2">&quot;Sequence&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">50</span>
        <span class="k">elif</span> <span class="s2">&quot;Fiendsmith&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">30</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">10</span>

    <span class="c1"># GY Fiendsmith count</span>
    <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;graveyard&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="s2">&quot;Fiendsmith&quot;</span> <span class="ow">in</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="mi">10</span>

    <span class="c1"># Hand resources</span>
    <span class="n">hand</span> <span class="o">=</span> <span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hand&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="c1"># Don&#39;t count dead cards (Holactie)</span>
    <span class="n">live_hand</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">hand</span> <span class="k">if</span> <span class="s2">&quot;Holactie&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span>
    <span class="n">score</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">live_hand</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>

    <span class="k">return</span> <span class="n">score</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1"># UTILITY FUNCTIONS</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="compare_boards">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.compare_boards">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_boards</span><span class="p">(</span><span class="n">sig1</span><span class="p">:</span> <span class="n">BoardSignature</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="n">BoardSignature</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compare two board signatures.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;same_monsters&quot;</span><span class="p">:</span> <span class="n">sig1</span><span class="o">.</span><span class="n">monsters</span> <span class="o">==</span> <span class="n">sig2</span><span class="o">.</span><span class="n">monsters</span><span class="p">,</span>
        <span class="s2">&quot;same_spells&quot;</span><span class="p">:</span> <span class="n">sig1</span><span class="o">.</span><span class="n">spells</span> <span class="o">==</span> <span class="n">sig2</span><span class="o">.</span><span class="n">spells</span><span class="p">,</span>
        <span class="s2">&quot;same_gy&quot;</span><span class="p">:</span> <span class="n">sig1</span><span class="o">.</span><span class="n">graveyard</span> <span class="o">==</span> <span class="n">sig2</span><span class="o">.</span><span class="n">graveyard</span><span class="p">,</span>
        <span class="s2">&quot;same_hand&quot;</span><span class="p">:</span> <span class="n">sig1</span><span class="o">.</span><span class="n">hand</span> <span class="o">==</span> <span class="n">sig2</span><span class="o">.</span><span class="n">hand</span><span class="p">,</span>
        <span class="s2">&quot;identical&quot;</span><span class="p">:</span> <span class="n">sig1</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span> <span class="o">==</span> <span class="n">sig2</span><span class="o">.</span><span class="n">hash</span><span class="p">(),</span>
        <span class="s2">&quot;monsters_diff&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;only_in_1&quot;</span><span class="p">:</span> <span class="n">sig1</span><span class="o">.</span><span class="n">monsters</span> <span class="o">-</span> <span class="n">sig2</span><span class="o">.</span><span class="n">monsters</span><span class="p">,</span>
            <span class="s2">&quot;only_in_2&quot;</span><span class="p">:</span> <span class="n">sig2</span><span class="o">.</span><span class="n">monsters</span> <span class="o">-</span> <span class="n">sig1</span><span class="o">.</span><span class="n">monsters</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="board_from_legacy">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.board_from_legacy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">board_from_legacy</span><span class="p">(</span><span class="n">board_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoardSignature</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert legacy board_state dict to BoardSignature.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">BoardSignature</span><span class="o">.</span><span class="n">from_board_state</span><span class="p">(</span><span class="n">board_state</span><span class="p">)</span></div>



<div class="viewcode-block" id="intermediate_from_legacy">
<a class="viewcode-back" href="../../../../modules/engine.html#src.ygo_combo.engine.state.intermediate_from_legacy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">intermediate_from_legacy</span><span class="p">(</span><span class="n">idle_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">board_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IntermediateState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert legacy data structures to IntermediateState.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">IntermediateState</span><span class="o">.</span><span class="n">from_idle_data</span><span class="p">(</span><span class="n">idle_data</span><span class="p">,</span> <span class="n">board_state</span><span class="p">)</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1"># TESTS</span>
<span class="c1"># =============================================================================</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Test BoardSignature</span>
    <span class="n">sig1</span> <span class="o">=</span> <span class="n">BoardSignature</span><span class="p">(</span>
        <span class="n">monsters</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">([</span><span class="mi">79559912</span><span class="p">,</span> <span class="mi">2463794</span><span class="p">]),</span>  <span class="c1"># Caesar + Requiem</span>
        <span class="n">spells</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
        <span class="n">graveyard</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">([</span><span class="mi">60764609</span><span class="p">]),</span>  <span class="c1"># Engraver in GY</span>
        <span class="n">hand</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
        <span class="n">banished</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
        <span class="n">extra_deck</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
        <span class="n">equips</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="n">sig2</span> <span class="o">=</span> <span class="n">BoardSignature</span><span class="p">(</span>
        <span class="n">monsters</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">([</span><span class="mi">2463794</span><span class="p">,</span> <span class="mi">79559912</span><span class="p">]),</span>  <span class="c1"># Same monsters, different order</span>
        <span class="n">spells</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
        <span class="n">graveyard</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">([</span><span class="mi">60764609</span><span class="p">]),</span>
        <span class="n">hand</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
        <span class="n">banished</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
        <span class="n">extra_deck</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
        <span class="n">equips</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BoardSignature tests:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  sig1.hash() = </span><span class="si">{</span><span class="n">sig1</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  sig2.hash() = </span><span class="si">{</span><span class="n">sig2</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Hashes equal: </span><span class="si">{</span><span class="n">sig1</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sig2</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Signatures equal: </span><span class="si">{</span><span class="n">sig1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sig2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test evaluation</span>
    <span class="n">eval_result</span> <span class="o">=</span> <span class="n">evaluate_board_quality</span><span class="p">(</span><span class="n">sig1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Board evaluation:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tier: </span><span class="si">{</span><span class="n">eval_result</span><span class="p">[</span><span class="s1">&#39;tier&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Score: </span><span class="si">{</span><span class="n">eval_result</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Details: </span><span class="si">{</span><span class="n">eval_result</span><span class="p">[</span><span class="s1">&#39;details&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test ActionSpec</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ActionSpec tests:&quot;</span><span class="p">)</span>
    <span class="n">act1</span> <span class="o">=</span> <span class="n">ActionSpec</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="mi">60764609</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LOCATION_HAND</span><span class="p">)</span>
    <span class="n">act2</span> <span class="o">=</span> <span class="n">ActionSpec</span><span class="o">.</span><span class="n">special_summon</span><span class="p">(</span><span class="mi">2463794</span><span class="p">)</span>
    <span class="n">act3</span> <span class="o">=</span> <span class="n">ActionSpec</span><span class="o">.</span><span class="n">pass_action</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Activate: </span><span class="si">{</span><span class="n">act1</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SpSummon: </span><span class="si">{</span><span class="n">act2</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pass: </span><span class="si">{</span><span class="n">act3</span><span class="o">.</span><span class="n">spec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Test IntermediateState</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">IntermediateState tests:&quot;</span><span class="p">)</span>
    <span class="n">idle_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;activatable&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">60764609</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="n">LOCATION_HAND</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">60764609</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="n">LOCATION_GRAVE</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
        <span class="p">],</span>
        <span class="s2">&quot;spsummon&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">2463794</span><span class="p">}],</span>
        <span class="s2">&quot;summonable&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;to_ep&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">board_state</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;player0&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;monsters&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">35552986</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Fiendsmith Token&quot;</span><span class="p">}],</span>
            <span class="s2">&quot;spells&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;graveyard&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="mi">60764609</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Fiendsmith Engraver&quot;</span><span class="p">}],</span>
            <span class="s2">&quot;hand&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;banished&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;extra&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">intermediate</span> <span class="o">=</span> <span class="n">IntermediateState</span><span class="o">.</span><span class="n">from_idle_data</span><span class="p">(</span><span class="n">idle_data</span><span class="p">,</span> <span class="n">board_state</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Hash: </span><span class="si">{</span><span class="n">intermediate</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Num actions: </span><span class="si">{</span><span class="n">intermediate</span><span class="o">.</span><span class="n">num_actions</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Can pass: </span><span class="si">{</span><span class="n">intermediate</span><span class="o">.</span><span class="n">can_pass</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Actions: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">intermediate</span><span class="o">.</span><span class="n">legal_actions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">All tests passed!&quot;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, YGO-Combo-Pipeline Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>