

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.ygo_combo.combo_enumeration &mdash; YGO-Combo-Pipeline 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            YGO-Combo-Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/types.html">Shared Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/engine.html">Engine Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/search.html">Search Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/cards.html">Cards Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/encoding.html">Encoding Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/enumeration.html">Enumeration Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/combo_enumeration.html">Combo Enumeration</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">YGO-Combo-Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">src.ygo_combo.combo_enumeration</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.ygo_combo.combo_enumeration</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exhaustive Combo Enumeration Engine</span>

<span class="sd">Explores ALL possible action sequences from a starting game state.</span>
<span class="sd">No AI makes decisions - code explores every legal path.</span>

<span class="sd">Key design:</span>
<span class="sd">- Forward replay (no save/restore)</span>
<span class="sd">- Branch at IDLE (all actions + PASS) and SELECT_CARD (all choices)</span>
<span class="sd">- Auto-decline chains (opponent has no responses)</span>
<span class="sd">- PASS creates terminal states</span>

<span class="sd">TODO (Phase 6 Refactoring):</span>
<span class="sd">    Consider splitting this module for parallelization:</span>
<span class="sd">    - enumeration_engine.py: Core EnumerationEngine class</span>
<span class="sd">    - message_handlers.py: _handle_idle, _handle_select_card, etc.</span>
<span class="sd">    - response_builders.py: build_activate_response, build_pass_response, etc.</span>
<span class="sd">    - message_parsers.py: parse_idle, parse_select_card, etc.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">BinaryIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Import shared types to avoid circular imports</span>
<span class="c1"># These are re-exported for backwards compatibility</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Action</span><span class="p">,</span> <span class="n">TerminalState</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Action</span><span class="p">,</span> <span class="n">TerminalState</span>

<span class="c1"># Configure module logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Global flag for graceful shutdown</span>
<span class="n">_shutdown_requested</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle interrupt signals for graceful shutdown.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_shutdown_requested</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_shutdown_requested</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Shutdown requested - finishing current path and saving results...&quot;</span><span class="p">)</span>
        <span class="n">_shutdown_requested</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Force quit - results may be incomplete.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span>

<span class="c1"># Import from engine interface (production code, not test file)</span>
<span class="c1"># Support both relative imports (package) and absolute imports (sys.path)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.engine.interface</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">init_card_database</span><span class="p">,</span> <span class="n">load_library</span><span class="p">,</span> <span class="n">preload_utility_scripts</span><span class="p">,</span>
        <span class="n">py_card_reader</span><span class="p">,</span> <span class="n">py_card_reader_done</span><span class="p">,</span> <span class="n">py_script_reader</span><span class="p">,</span> <span class="n">py_log_handler</span><span class="p">,</span>
        <span class="n">ffi</span><span class="p">,</span> <span class="n">get_card_name</span><span class="p">,</span> <span class="n">set_lib</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.engine.bindings</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">LOCATION_DECK</span><span class="p">,</span> <span class="n">LOCATION_HAND</span><span class="p">,</span> <span class="n">LOCATION_EXTRA</span><span class="p">,</span> <span class="n">LOCATION_MZONE</span><span class="p">,</span>
        <span class="n">LOCATION_GRAVE</span><span class="p">,</span> <span class="n">LOCATION_SZONE</span><span class="p">,</span> <span class="n">LOCATION_REMOVED</span><span class="p">,</span>
        <span class="n">POS_FACEDOWN_DEFENSE</span><span class="p">,</span> <span class="n">POS_FACEUP_ATTACK</span><span class="p">,</span>
        <span class="n">QUERY_CODE</span><span class="p">,</span> <span class="n">QUERY_POSITION</span><span class="p">,</span> <span class="n">QUERY_ATTACK</span><span class="p">,</span> <span class="n">QUERY_DEFENSE</span><span class="p">,</span> <span class="n">QUERY_END</span><span class="p">,</span>
        <span class="n">MSG_SELECT_BATTLECMD</span><span class="p">,</span> <span class="n">MSG_IDLE</span><span class="p">,</span> <span class="n">MSG_SELECT_CARD</span><span class="p">,</span> <span class="n">MSG_SELECT_CHAIN</span><span class="p">,</span>
        <span class="n">MSG_SELECT_PLACE</span><span class="p">,</span> <span class="n">MSG_SELECT_POSITION</span><span class="p">,</span> <span class="n">MSG_SELECT_TRIBUTE</span><span class="p">,</span>
        <span class="n">MSG_SELECT_EFFECTYN</span><span class="p">,</span> <span class="n">MSG_SELECT_YESNO</span><span class="p">,</span> <span class="n">MSG_SELECT_OPTION</span><span class="p">,</span>
        <span class="n">MSG_SELECT_COUNTER</span><span class="p">,</span> <span class="n">MSG_SELECT_UNSELECT_CARD</span><span class="p">,</span> <span class="n">MSG_SELECT_SUM</span><span class="p">,</span>
        <span class="n">MSG_SORT_CARD</span><span class="p">,</span> <span class="n">MSG_SELECT_DISFIELD</span><span class="p">,</span>
        <span class="n">MSG_RETRY</span><span class="p">,</span> <span class="n">MSG_HINT</span><span class="p">,</span> <span class="n">MSG_WAITING</span><span class="p">,</span> <span class="n">MSG_START</span><span class="p">,</span> <span class="n">MSG_WIN</span><span class="p">,</span>
        <span class="n">MSG_UPDATE_DATA</span><span class="p">,</span> <span class="n">MSG_UPDATE_CARD</span><span class="p">,</span>
        <span class="n">MSG_CONFIRM_DECKTOP</span><span class="p">,</span> <span class="n">MSG_CONFIRM_CARDS</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_DECK</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_HAND</span><span class="p">,</span>
        <span class="n">MSG_REFRESH_DECK</span><span class="p">,</span> <span class="n">MSG_SWAP_GRAVE_DECK</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_SET_CARD</span><span class="p">,</span> <span class="n">MSG_REVERSE_DECK</span><span class="p">,</span>
        <span class="n">MSG_DECK_TOP</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_EXTRA</span><span class="p">,</span>
        <span class="n">MSG_NEW_TURN</span><span class="p">,</span> <span class="n">MSG_NEW_PHASE</span><span class="p">,</span> <span class="n">MSG_CONFIRM_EXTRATOP</span><span class="p">,</span>
        <span class="n">MSG_MOVE</span><span class="p">,</span> <span class="n">MSG_POS_CHANGE</span><span class="p">,</span> <span class="n">MSG_SET</span><span class="p">,</span> <span class="n">MSG_SWAP</span><span class="p">,</span> <span class="n">MSG_FIELD_DISABLED</span><span class="p">,</span>
        <span class="n">MSG_SUMMONING</span><span class="p">,</span> <span class="n">MSG_SUMMONED</span><span class="p">,</span> <span class="n">MSG_SPSUMMONING</span><span class="p">,</span> <span class="n">MSG_SPSUMMONED</span><span class="p">,</span>
        <span class="n">MSG_FLIPSUMMONING</span><span class="p">,</span> <span class="n">MSG_FLIPSUMMONED</span><span class="p">,</span>
        <span class="n">MSG_CHAINING</span><span class="p">,</span> <span class="n">MSG_CHAINED</span><span class="p">,</span> <span class="n">MSG_CHAIN_SOLVING</span><span class="p">,</span> <span class="n">MSG_CHAIN_SOLVED</span><span class="p">,</span>
        <span class="n">MSG_CHAIN_END</span><span class="p">,</span> <span class="n">MSG_CHAIN_NEGATED</span><span class="p">,</span> <span class="n">MSG_CHAIN_DISABLED</span><span class="p">,</span>
        <span class="n">MSG_CARD_SELECTED</span><span class="p">,</span> <span class="n">MSG_RANDOM_SELECTED</span><span class="p">,</span> <span class="n">MSG_BECOME_TARGET</span><span class="p">,</span>
        <span class="n">MSG_DRAW</span><span class="p">,</span> <span class="n">MSG_DAMAGE</span><span class="p">,</span> <span class="n">MSG_RECOVER</span><span class="p">,</span> <span class="n">MSG_EQUIP</span><span class="p">,</span> <span class="n">MSG_LPUPDATE</span><span class="p">,</span> <span class="n">MSG_UNEQUIP</span><span class="p">,</span>
        <span class="n">MSG_CARD_TARGET</span><span class="p">,</span> <span class="n">MSG_CANCEL_TARGET</span><span class="p">,</span> <span class="n">MSG_PAY_LPCOST</span><span class="p">,</span>
        <span class="n">MSG_ADD_COUNTER</span><span class="p">,</span> <span class="n">MSG_REMOVE_COUNTER</span><span class="p">,</span>
        <span class="n">MSG_ATTACK</span><span class="p">,</span> <span class="n">MSG_BATTLE</span><span class="p">,</span> <span class="n">MSG_ATTACK_DISABLED</span><span class="p">,</span>
        <span class="n">MSG_DAMAGE_STEP_START</span><span class="p">,</span> <span class="n">MSG_DAMAGE_STEP_END</span><span class="p">,</span>
        <span class="n">MSG_MISSED_EFFECT</span><span class="p">,</span> <span class="n">MSG_BE_CHAIN_TARGET</span><span class="p">,</span> <span class="n">MSG_CREATE_RELATION</span><span class="p">,</span> <span class="n">MSG_RELEASE_RELATION</span><span class="p">,</span>
        <span class="n">MSG_TOSS_COIN</span><span class="p">,</span> <span class="n">MSG_TOSS_DICE</span><span class="p">,</span> <span class="n">MSG_ROCK_PAPER_SCISSORS</span><span class="p">,</span> <span class="n">MSG_HAND_RES</span><span class="p">,</span>
        <span class="n">MSG_ANNOUNCE_RACE</span><span class="p">,</span> <span class="n">MSG_ANNOUNCE_ATTRIB</span><span class="p">,</span> <span class="n">MSG_ANNOUNCE_CARD</span><span class="p">,</span> <span class="n">MSG_ANNOUNCE_NUMBER</span><span class="p">,</span>
        <span class="n">MSG_CARD_HINT</span><span class="p">,</span> <span class="n">MSG_TAG_SWAP</span><span class="p">,</span> <span class="n">MSG_RELOAD_FIELD</span><span class="p">,</span> <span class="n">MSG_AI_NAME</span><span class="p">,</span>
        <span class="n">MSG_SHOW_HINT</span><span class="p">,</span> <span class="n">MSG_PLAYER_HINT</span><span class="p">,</span> <span class="n">MSG_MATCH_KILL</span><span class="p">,</span> <span class="n">MSG_CUSTOM_MSG</span><span class="p">,</span> <span class="n">MSG_REMOVE_CARDS</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.engine.state</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">BoardSignature</span><span class="p">,</span> <span class="n">IntermediateState</span><span class="p">,</span> <span class="n">ActionSpec</span><span class="p">,</span>
        <span class="n">evaluate_board_quality</span><span class="p">,</span> <span class="n">BOSS_MONSTERS</span><span class="p">,</span> <span class="n">INTERACTION_PIECES</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.engine.board_capture</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">parse_query_response</span><span class="p">,</span> <span class="n">compute_board_signature</span><span class="p">,</span>
        <span class="n">compute_idle_state_hash</span><span class="p">,</span> <span class="n">capture_board_state</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.engine.duel_factory</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">ENGRAVER</span><span class="p">,</span> <span class="n">HOLACTIE</span><span class="p">,</span>
        <span class="n">load_locked_library</span><span class="p">,</span> <span class="n">get_deck_lists</span><span class="p">,</span> <span class="n">create_duel</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.search.transposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">TranspositionTable</span><span class="p">,</span> <span class="n">TranspositionEntry</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.cards.validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">CardValidator</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.enumeration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">read_u8</span><span class="p">,</span> <span class="n">read_u16</span><span class="p">,</span> <span class="n">read_u32</span><span class="p">,</span> <span class="n">read_i32</span><span class="p">,</span> <span class="n">read_u64</span><span class="p">,</span>
        <span class="n">parse_idle</span><span class="p">,</span> <span class="n">parse_select_card</span><span class="p">,</span> <span class="n">parse_select_chain</span><span class="p">,</span> <span class="n">parse_select_place</span><span class="p">,</span>
        <span class="n">parse_select_unselect_card</span><span class="p">,</span> <span class="n">parse_select_option</span><span class="p">,</span> <span class="n">parse_select_tribute</span><span class="p">,</span>
        <span class="n">parse_select_sum</span><span class="p">,</span> <span class="n">find_valid_tribute_combinations</span><span class="p">,</span>
        <span class="n">find_valid_sum_combinations</span><span class="p">,</span> <span class="n">find_sum_combinations_flexible</span><span class="p">,</span>
        <span class="n">IDLE_RESPONSE_SUMMON</span><span class="p">,</span> <span class="n">IDLE_RESPONSE_SPSUMMON</span><span class="p">,</span> <span class="n">IDLE_RESPONSE_REPOSITION</span><span class="p">,</span>
        <span class="n">IDLE_RESPONSE_MSET</span><span class="p">,</span> <span class="n">IDLE_RESPONSE_SSET</span><span class="p">,</span> <span class="n">IDLE_RESPONSE_ACTIVATE</span><span class="p">,</span>
        <span class="n">IDLE_RESPONSE_TO_BATTLE</span><span class="p">,</span> <span class="n">IDLE_RESPONSE_TO_END</span><span class="p">,</span>
        <span class="n">build_activate_response</span><span class="p">,</span> <span class="n">build_pass_response</span><span class="p">,</span> <span class="n">build_select_card_response</span><span class="p">,</span>
        <span class="n">build_decline_chain_response</span><span class="p">,</span> <span class="n">build_select_tribute_response</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Fallback for direct execution (sys.path includes src/ygo_combo)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">engine.interface</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">init_card_database</span><span class="p">,</span> <span class="n">load_library</span><span class="p">,</span> <span class="n">preload_utility_scripts</span><span class="p">,</span>
        <span class="n">py_card_reader</span><span class="p">,</span> <span class="n">py_card_reader_done</span><span class="p">,</span> <span class="n">py_script_reader</span><span class="p">,</span> <span class="n">py_log_handler</span><span class="p">,</span>
        <span class="n">ffi</span><span class="p">,</span> <span class="n">get_card_name</span><span class="p">,</span> <span class="n">set_lib</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">engine.bindings</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">LOCATION_DECK</span><span class="p">,</span> <span class="n">LOCATION_HAND</span><span class="p">,</span> <span class="n">LOCATION_EXTRA</span><span class="p">,</span> <span class="n">LOCATION_MZONE</span><span class="p">,</span>
        <span class="n">LOCATION_GRAVE</span><span class="p">,</span> <span class="n">LOCATION_SZONE</span><span class="p">,</span> <span class="n">LOCATION_REMOVED</span><span class="p">,</span>
        <span class="n">POS_FACEDOWN_DEFENSE</span><span class="p">,</span> <span class="n">POS_FACEUP_ATTACK</span><span class="p">,</span>
        <span class="n">QUERY_CODE</span><span class="p">,</span> <span class="n">QUERY_POSITION</span><span class="p">,</span> <span class="n">QUERY_ATTACK</span><span class="p">,</span> <span class="n">QUERY_DEFENSE</span><span class="p">,</span> <span class="n">QUERY_END</span><span class="p">,</span>
        <span class="n">MSG_SELECT_BATTLECMD</span><span class="p">,</span> <span class="n">MSG_IDLE</span><span class="p">,</span> <span class="n">MSG_SELECT_CARD</span><span class="p">,</span> <span class="n">MSG_SELECT_CHAIN</span><span class="p">,</span>
        <span class="n">MSG_SELECT_PLACE</span><span class="p">,</span> <span class="n">MSG_SELECT_POSITION</span><span class="p">,</span> <span class="n">MSG_SELECT_TRIBUTE</span><span class="p">,</span>
        <span class="n">MSG_SELECT_EFFECTYN</span><span class="p">,</span> <span class="n">MSG_SELECT_YESNO</span><span class="p">,</span> <span class="n">MSG_SELECT_OPTION</span><span class="p">,</span>
        <span class="n">MSG_SELECT_COUNTER</span><span class="p">,</span> <span class="n">MSG_SELECT_UNSELECT_CARD</span><span class="p">,</span> <span class="n">MSG_SELECT_SUM</span><span class="p">,</span>
        <span class="n">MSG_SORT_CARD</span><span class="p">,</span> <span class="n">MSG_SELECT_DISFIELD</span><span class="p">,</span>
        <span class="n">MSG_RETRY</span><span class="p">,</span> <span class="n">MSG_HINT</span><span class="p">,</span> <span class="n">MSG_WAITING</span><span class="p">,</span> <span class="n">MSG_START</span><span class="p">,</span> <span class="n">MSG_WIN</span><span class="p">,</span>
        <span class="n">MSG_UPDATE_DATA</span><span class="p">,</span> <span class="n">MSG_UPDATE_CARD</span><span class="p">,</span>
        <span class="n">MSG_CONFIRM_DECKTOP</span><span class="p">,</span> <span class="n">MSG_CONFIRM_CARDS</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_DECK</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_HAND</span><span class="p">,</span>
        <span class="n">MSG_REFRESH_DECK</span><span class="p">,</span> <span class="n">MSG_SWAP_GRAVE_DECK</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_SET_CARD</span><span class="p">,</span> <span class="n">MSG_REVERSE_DECK</span><span class="p">,</span>
        <span class="n">MSG_DECK_TOP</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_EXTRA</span><span class="p">,</span>
        <span class="n">MSG_NEW_TURN</span><span class="p">,</span> <span class="n">MSG_NEW_PHASE</span><span class="p">,</span> <span class="n">MSG_CONFIRM_EXTRATOP</span><span class="p">,</span>
        <span class="n">MSG_MOVE</span><span class="p">,</span> <span class="n">MSG_POS_CHANGE</span><span class="p">,</span> <span class="n">MSG_SET</span><span class="p">,</span> <span class="n">MSG_SWAP</span><span class="p">,</span> <span class="n">MSG_FIELD_DISABLED</span><span class="p">,</span>
        <span class="n">MSG_SUMMONING</span><span class="p">,</span> <span class="n">MSG_SUMMONED</span><span class="p">,</span> <span class="n">MSG_SPSUMMONING</span><span class="p">,</span> <span class="n">MSG_SPSUMMONED</span><span class="p">,</span>
        <span class="n">MSG_FLIPSUMMONING</span><span class="p">,</span> <span class="n">MSG_FLIPSUMMONED</span><span class="p">,</span>
        <span class="n">MSG_CHAINING</span><span class="p">,</span> <span class="n">MSG_CHAINED</span><span class="p">,</span> <span class="n">MSG_CHAIN_SOLVING</span><span class="p">,</span> <span class="n">MSG_CHAIN_SOLVED</span><span class="p">,</span>
        <span class="n">MSG_CHAIN_END</span><span class="p">,</span> <span class="n">MSG_CHAIN_NEGATED</span><span class="p">,</span> <span class="n">MSG_CHAIN_DISABLED</span><span class="p">,</span>
        <span class="n">MSG_CARD_SELECTED</span><span class="p">,</span> <span class="n">MSG_RANDOM_SELECTED</span><span class="p">,</span> <span class="n">MSG_BECOME_TARGET</span><span class="p">,</span>
        <span class="n">MSG_DRAW</span><span class="p">,</span> <span class="n">MSG_DAMAGE</span><span class="p">,</span> <span class="n">MSG_RECOVER</span><span class="p">,</span> <span class="n">MSG_EQUIP</span><span class="p">,</span> <span class="n">MSG_LPUPDATE</span><span class="p">,</span> <span class="n">MSG_UNEQUIP</span><span class="p">,</span>
        <span class="n">MSG_CARD_TARGET</span><span class="p">,</span> <span class="n">MSG_CANCEL_TARGET</span><span class="p">,</span> <span class="n">MSG_PAY_LPCOST</span><span class="p">,</span>
        <span class="n">MSG_ADD_COUNTER</span><span class="p">,</span> <span class="n">MSG_REMOVE_COUNTER</span><span class="p">,</span>
        <span class="n">MSG_ATTACK</span><span class="p">,</span> <span class="n">MSG_BATTLE</span><span class="p">,</span> <span class="n">MSG_ATTACK_DISABLED</span><span class="p">,</span>
        <span class="n">MSG_DAMAGE_STEP_START</span><span class="p">,</span> <span class="n">MSG_DAMAGE_STEP_END</span><span class="p">,</span>
        <span class="n">MSG_MISSED_EFFECT</span><span class="p">,</span> <span class="n">MSG_BE_CHAIN_TARGET</span><span class="p">,</span> <span class="n">MSG_CREATE_RELATION</span><span class="p">,</span> <span class="n">MSG_RELEASE_RELATION</span><span class="p">,</span>
        <span class="n">MSG_TOSS_COIN</span><span class="p">,</span> <span class="n">MSG_TOSS_DICE</span><span class="p">,</span> <span class="n">MSG_ROCK_PAPER_SCISSORS</span><span class="p">,</span> <span class="n">MSG_HAND_RES</span><span class="p">,</span>
        <span class="n">MSG_ANNOUNCE_RACE</span><span class="p">,</span> <span class="n">MSG_ANNOUNCE_ATTRIB</span><span class="p">,</span> <span class="n">MSG_ANNOUNCE_CARD</span><span class="p">,</span> <span class="n">MSG_ANNOUNCE_NUMBER</span><span class="p">,</span>
        <span class="n">MSG_CARD_HINT</span><span class="p">,</span> <span class="n">MSG_TAG_SWAP</span><span class="p">,</span> <span class="n">MSG_RELOAD_FIELD</span><span class="p">,</span> <span class="n">MSG_AI_NAME</span><span class="p">,</span>
        <span class="n">MSG_SHOW_HINT</span><span class="p">,</span> <span class="n">MSG_PLAYER_HINT</span><span class="p">,</span> <span class="n">MSG_MATCH_KILL</span><span class="p">,</span> <span class="n">MSG_CUSTOM_MSG</span><span class="p">,</span> <span class="n">MSG_REMOVE_CARDS</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">engine.state</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">BoardSignature</span><span class="p">,</span> <span class="n">IntermediateState</span><span class="p">,</span> <span class="n">ActionSpec</span><span class="p">,</span>
        <span class="n">evaluate_board_quality</span><span class="p">,</span> <span class="n">BOSS_MONSTERS</span><span class="p">,</span> <span class="n">INTERACTION_PIECES</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">engine.board_capture</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">parse_query_response</span><span class="p">,</span> <span class="n">compute_board_signature</span><span class="p">,</span>
        <span class="n">compute_idle_state_hash</span><span class="p">,</span> <span class="n">capture_board_state</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">engine.duel_factory</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">ENGRAVER</span><span class="p">,</span> <span class="n">HOLACTIE</span><span class="p">,</span>
        <span class="n">load_locked_library</span><span class="p">,</span> <span class="n">get_deck_lists</span><span class="p">,</span> <span class="n">create_duel</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">search.transposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">TranspositionTable</span><span class="p">,</span> <span class="n">TranspositionEntry</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">cards.validator</span><span class="w"> </span><span class="kn">import</span> <span class="n">CardValidator</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">enumeration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">read_u8</span><span class="p">,</span> <span class="n">read_u16</span><span class="p">,</span> <span class="n">read_u32</span><span class="p">,</span> <span class="n">read_i32</span><span class="p">,</span> <span class="n">read_u64</span><span class="p">,</span>
        <span class="n">parse_idle</span><span class="p">,</span> <span class="n">parse_select_card</span><span class="p">,</span> <span class="n">parse_select_chain</span><span class="p">,</span> <span class="n">parse_select_place</span><span class="p">,</span>
        <span class="n">parse_select_unselect_card</span><span class="p">,</span> <span class="n">parse_select_option</span><span class="p">,</span> <span class="n">parse_select_tribute</span><span class="p">,</span>
        <span class="n">parse_select_sum</span><span class="p">,</span> <span class="n">find_valid_tribute_combinations</span><span class="p">,</span>
        <span class="n">find_valid_sum_combinations</span><span class="p">,</span> <span class="n">find_sum_combinations_flexible</span><span class="p">,</span>
        <span class="n">IDLE_RESPONSE_SUMMON</span><span class="p">,</span> <span class="n">IDLE_RESPONSE_SPSUMMON</span><span class="p">,</span> <span class="n">IDLE_RESPONSE_REPOSITION</span><span class="p">,</span>
        <span class="n">IDLE_RESPONSE_MSET</span><span class="p">,</span> <span class="n">IDLE_RESPONSE_SSET</span><span class="p">,</span> <span class="n">IDLE_RESPONSE_ACTIVATE</span><span class="p">,</span>
        <span class="n">IDLE_RESPONSE_TO_BATTLE</span><span class="p">,</span> <span class="n">IDLE_RESPONSE_TO_END</span><span class="p">,</span>
        <span class="n">build_activate_response</span><span class="p">,</span> <span class="n">build_pass_response</span><span class="p">,</span> <span class="n">build_select_card_response</span><span class="p">,</span>
        <span class="n">build_decline_chain_response</span><span class="p">,</span> <span class="n">build_select_tribute_response</span><span class="p">,</span>
    <span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># MESSAGE TYPE NAMES (for debugging)</span>
<span class="c1"># =============================================================================</span>

<span class="n">MSG_TYPE_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">11</span><span class="p">:</span> <span class="s2">&quot;MSG_IDLE&quot;</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_EFFECTYN&quot;</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_YESNO&quot;</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_OPTION&quot;</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_CARD&quot;</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_CHAIN&quot;</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_TRIBUTE&quot;</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_PLACE&quot;</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_POSITION&quot;</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_COUNTER&quot;</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_SUM&quot;</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_DISFIELD&quot;</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">:</span> <span class="s2">&quot;MSG_SORT_CARD&quot;</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">:</span> <span class="s2">&quot;MSG_SELECT_UNSELECT_CARD&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># SUM ENUMERATION - Now imported from enumeration.sum_utils</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Functions moved to src/ygo_combo/enumeration/sum_utils.py:</span>
<span class="c1"># - find_valid_sum_combinations()</span>
<span class="c1"># - find_sum_combinations_flexible()</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># CONFIGURATION - Now imported from engine.duel_factory</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># ENGRAVER, HOLACTIE constants imported from engine.duel_factory</span>
<span class="c1"># load_locked_library(), get_deck_lists(), create_duel() imported from engine.duel_factory</span>

<span class="c1"># Limits</span>
<span class="n">MAX_DEPTH</span> <span class="o">=</span> <span class="mi">50</span>          <span class="c1"># Maximum actions per path</span>
<span class="n">MAX_PATHS</span> <span class="o">=</span> <span class="mi">100000</span>      <span class="c1"># Maximum paths to explore (safety limit)</span>
<span class="n">MAX_ITERATIONS</span> <span class="o">=</span> <span class="mi">1000</span>   <span class="c1"># Maximum engine iterations per action</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># DATA STRUCTURES - Now imported from types.py</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Action and TerminalState are now defined in src/ygo_combo/types.py</span>
<span class="c1"># to avoid circular import issues. They are imported at the top of this file</span>
<span class="c1"># and re-exported for backwards compatibility.</span>
<span class="c1">#</span>
<span class="c1"># See: src/ygo_combo/types.py</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># LIBRARY LOADING &amp; DUEL CREATION - Now imported from engine.duel_factory</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Functions moved to src/ygo_combo/engine/duel_factory.py:</span>
<span class="c1"># - load_locked_library()</span>
<span class="c1"># - get_deck_lists()</span>
<span class="c1"># - create_duel()</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># MESSAGE PARSING - Moved to enumeration/parsers.py</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Functions: read_u8, read_u16, read_u32, read_i32, read_u64</span>
<span class="c1">#            parse_idle, parse_select_card, parse_select_chain, parse_select_place,</span>
<span class="c1">#            parse_select_unselect_card, parse_select_option, parse_select_tribute,</span>
<span class="c1">#            parse_select_sum, find_valid_tribute_combinations</span>
<span class="c1"># Import from: enumeration.parsers</span>


<span class="c1"># Legacy definitions removed - now imported from enumeration submodule</span>
<span class="c1"># (Keeping parse_query_response here as it uses QUERY_* constants)</span>

<span class="c1"># Marker for parser removal start</span>
<span class="c1"># (Functions removed - now imported from enumeration submodule)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># BOARD STATE CAPTURE - Now imported from engine.board_capture</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Functions moved to src/ygo_combo/engine/board_capture.py:</span>
<span class="c1"># - parse_query_response()</span>
<span class="c1"># - compute_board_signature()</span>
<span class="c1"># - compute_idle_state_hash()</span>
<span class="c1"># - capture_board_state()</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># ENUMERATION ENGINE</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="EnumerationEngine">
<a class="viewcode-back" href="../../../modules/combo_enumeration.html#src.ygo_combo.combo_enumeration.EnumerationEngine">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EnumerationEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exhaustive combo path enumeration with deduplication optimizations.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="EnumerationEngine.__init__">
<a class="viewcode-back" href="../../../modules/combo_enumeration.html#src.ygo_combo.combo_enumeration.EnumerationEngine.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span> <span class="n">main_deck</span><span class="p">,</span> <span class="n">extra_deck</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dedupe_boards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dedupe_intermediate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">prioritize_cards</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lib</span> <span class="o">=</span> <span class="n">lib</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_deck</span> <span class="o">=</span> <span class="n">main_deck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_deck</span> <span class="o">=</span> <span class="n">extra_deck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedupe_boards</span> <span class="o">=</span> <span class="n">dedupe_boards</span>  <span class="c1"># Skip duplicate terminal board states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedupe_intermediate</span> <span class="o">=</span> <span class="n">dedupe_intermediate</span>  <span class="c1"># Skip duplicate intermediate states</span>

        <span class="c1"># Card prioritization for SELECT_CARD - these codes are explored first</span>
        <span class="c1"># Format: list of card passcodes to prioritize (explored in order given)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prioritize_cards</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">prioritize_cards</span><span class="p">)</span> <span class="k">if</span> <span class="n">prioritize_cards</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prioritize_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prioritize_cards</span><span class="p">)</span> <span class="k">if</span> <span class="n">prioritize_cards</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">terminals</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># All terminal states found</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># Counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth_seen</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># Deepest path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen_board_sigs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Board signatures already recorded (terminals)</span>

        <span class="c1"># Transposition table for intermediate state deduplication</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transposition_table</span> <span class="o">=</span> <span class="n">TranspositionTable</span><span class="p">(</span><span class="n">max_size</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">)</span>

        <span class="c1"># Group terminals by board signature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_boards</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># board_hash -&gt; list of action sequences</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_boards_skipped</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_states_pruned</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for intermediate pruning</span>

        <span class="c1"># Failed choice tracking for SELECT_SUM_CANCEL backtracking</span>
        <span class="c1"># Maps (context_hash) -&gt; set of failed card codes</span>
        <span class="c1"># Context hash identifies the SELECT_CARD prompt (based on available cards)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed_at_context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">set</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Custom starting hand (None = use default)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_starting_hand</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_recurse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call the appropriate recursive method based on whether custom hand is set.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starting_hand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enumerate_recursive_with_hand</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enumerate_recursive</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>

<div class="viewcode-block" id="EnumerationEngine.log">
<a class="viewcode-back" href="../../../modules/combo_enumeration.html#src.ygo_combo.combo_enumeration.EnumerationEngine.log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">depth</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_select_card_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute a context hash for a SELECT_CARD prompt.</span>

<span class="sd">        The context identifies this specific decision point based on:</span>
<span class="sd">        - Which cards are available to select</span>
<span class="sd">        - The selection constraints (min/max)</span>

<span class="sd">        This allows us to track which cards have failed at THIS decision point,</span>
<span class="sd">        even if we reach it via different paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="n">select_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cards&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">codes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">))</span>
        <span class="n">min_sel</span> <span class="o">=</span> <span class="n">select_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">max_sel</span> <span class="o">=</span> <span class="n">select_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="n">codes</span><span class="p">,</span> <span class="n">min_sel</span><span class="p">,</span> <span class="n">max_sel</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_mark_card_failed_at_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_hash</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">card_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark a card as failed at a specific SELECT_CARD context.</span>

<span class="sd">        Called when a SELECT_CARD choice leads to SELECT_SUM_CANCEL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_at_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failed_at_context</span><span class="p">[</span><span class="n">context_hash</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed_at_context</span><span class="p">[</span><span class="n">context_hash</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">card_code</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_failed_cards_at_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_hash</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the set of cards that have failed at this context.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_at_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">context_hash</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

<div class="viewcode-block" id="EnumerationEngine.enumerate_all">
<a class="viewcode-back" href="../../../modules/combo_enumeration.html#src.ygo_combo.combo_enumeration.EnumerationEngine.enumerate_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">enumerate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main entry point - enumerate all paths from starting state.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STARTING ENUMERATION&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max depth: </span><span class="si">{</span><span class="n">MAX_DEPTH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max paths: </span><span class="si">{</span><span class="n">MAX_PATHS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_enumerate_recursive</span><span class="p">([])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ENUMERATION COMPLETE&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Paths explored: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Terminal states: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminals</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique boards&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unique board signatures: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_boards</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedupe_boards</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicate terminal boards skipped: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">duplicate_boards_skipped</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedupe_intermediate</span><span class="p">:</span>
            <span class="n">tt_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transposition_table</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Intermediate states pruned: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_states_pruned</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transposition table: </span><span class="si">{</span><span class="n">tt_stats</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> entries, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tt_stats</span><span class="p">[</span><span class="s1">&#39;hit_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> hit rate&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max depth seen: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth_seen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminals</span></div>


<div class="viewcode-block" id="EnumerationEngine.enumerate_from_hand">
<a class="viewcode-back" href="../../../modules/combo_enumeration.html#src.ygo_combo.combo_enumeration.EnumerationEngine.enumerate_from_hand">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">enumerate_from_hand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">starting_hand</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TerminalState</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enumerate combos from a specific starting hand.</span>

<span class="sd">        Args:</span>
<span class="sd">            starting_hand: List of up to 5 card passcodes for starting hand.</span>
<span class="sd">                          Will be padded with HOLACTIE if less than 5 cards.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of terminal states (completed combo boards).</span>

<span class="sd">        Example:</span>
<span class="sd">            # Test Engraver + Terrortop opener</span>
<span class="sd">            hand = [60764609, 81275020, 14558127, 14558127, 14558127]</span>
<span class="sd">            results = engine.enumerate_from_hand(hand)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">starting_hand</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Hand cannot be empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starting_hand</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hand has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">starting_hand</span><span class="p">)</span><span class="si">}</span><span class="s2"> cards, truncating to 5&quot;</span><span class="p">)</span>
            <span class="n">starting_hand</span> <span class="o">=</span> <span class="n">starting_hand</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>

        <span class="c1"># Store the starting hand for create_duel calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_starting_hand</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">starting_hand</span><span class="p">)</span>

        <span class="c1"># Reset state for fresh enumeration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth_seen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen_board_sigs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_boards</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_boards_skipped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_states_pruned</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transposition_table</span> <span class="o">=</span> <span class="n">TranspositionTable</span><span class="p">(</span><span class="n">max_size</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ENUMERATE FROM HAND&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hand: </span><span class="si">{</span><span class="n">starting_hand</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max depth: </span><span class="si">{</span><span class="n">MAX_DEPTH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max paths: </span><span class="si">{</span><span class="n">MAX_PATHS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_enumerate_recursive_with_hand</span><span class="p">([])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ENUMERATION COMPLETE&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Paths explored: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Terminal states: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminals</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique boards&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max depth seen: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth_seen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminals</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_enumerate_recursive_with_hand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively explore all paths using stored starting hand.&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_shutdown_requested</span>

        <span class="c1"># Check for graceful shutdown</span>
        <span class="k">if</span> <span class="n">_shutdown_requested</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Safety limits</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_DEPTH</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_record_terminal</span><span class="p">(</span><span class="n">action_history</span><span class="p">,</span> <span class="s2">&quot;MAX_DEPTH&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span> <span class="o">&gt;=</span> <span class="n">MAX_PATHS</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth_seen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth_seen</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Progress: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span><span class="si">}</span><span class="s2"> paths, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminals</span><span class="p">)</span><span class="si">}</span><span class="s2"> terminals&quot;</span><span class="p">)</span>

        <span class="c1"># Create fresh duel with the specific starting hand</span>
        <span class="n">duel</span> <span class="o">=</span> <span class="n">create_duel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_deck</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_deck</span><span class="p">,</span>
                           <span class="n">starting_hand</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_starting_hand</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start duel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_StartDuel</span><span class="p">(</span><span class="n">duel</span><span class="p">)</span>

            <span class="c1"># Replay all previous actions</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">action_history</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replay_action</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replay failed at action: </span><span class="si">{</span><span class="n">action</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">))</span>
                    <span class="k">return</span>

            <span class="c1"># Now explore from current state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_explore_from_state</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_DestroyDuel</span><span class="p">(</span><span class="n">duel</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_enumerate_recursive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively explore all paths from current action history.&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_shutdown_requested</span>

        <span class="c1"># Check for graceful shutdown</span>
        <span class="k">if</span> <span class="n">_shutdown_requested</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Safety limits</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_DEPTH</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_record_terminal</span><span class="p">(</span><span class="n">action_history</span><span class="p">,</span> <span class="s2">&quot;MAX_DEPTH&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span> <span class="o">&gt;=</span> <span class="n">MAX_PATHS</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth_seen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth_seen</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Progress: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">paths_explored</span><span class="si">}</span><span class="s2"> paths, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminals</span><span class="p">)</span><span class="si">}</span><span class="s2"> terminals&quot;</span><span class="p">)</span>

        <span class="c1"># Create fresh duel and replay action history</span>
        <span class="n">duel</span> <span class="o">=</span> <span class="n">create_duel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_deck</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_deck</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Start duel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_StartDuel</span><span class="p">(</span><span class="n">duel</span><span class="p">)</span>

            <span class="c1"># Replay all previous actions</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">action_history</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replay_action</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replay failed at action: </span><span class="si">{</span><span class="n">action</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">))</span>
                    <span class="k">return</span>

            <span class="c1"># Now explore from current state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_explore_from_state</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_DestroyDuel</span><span class="p">(</span><span class="n">duel</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_replay_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">Action</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replay a single action, handling any intermediate prompts.&quot;&quot;&quot;</span>

        <span class="c1"># Process until we need the action&#39;s response</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_ITERATIONS</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_DuelProcess</span><span class="p">(</span><span class="n">duel</span><span class="p">)</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_messages</span><span class="p">(</span><span class="n">duel</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">msg_data</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_CHAIN</span><span class="p">:</span>
                    <span class="c1"># Auto-decline chains during replay</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">build_decline_chain_response</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_DuelSetResponse</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">action</span><span class="o">.</span><span class="n">message_type</span><span class="p">:</span>
                    <span class="c1"># This is the prompt we need to respond to</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_DuelSetResponse</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">response_bytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">response_bytes</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># DUEL_END</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>  <span class="c1"># AWAITING but no messages?</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Max iterations</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_explore_from_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Explore all branches from current duel state.&quot;&quot;&quot;</span>

        <span class="c1"># Informational message types that don&#39;t require responses</span>
        <span class="n">INFORMATIONAL</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">MSG_HINT</span><span class="p">,</span> <span class="n">MSG_WAITING</span><span class="p">,</span> <span class="n">MSG_START</span><span class="p">,</span> <span class="n">MSG_WIN</span><span class="p">,</span> <span class="n">MSG_UPDATE_DATA</span><span class="p">,</span> <span class="n">MSG_UPDATE_CARD</span><span class="p">,</span>
            <span class="n">MSG_CONFIRM_DECKTOP</span><span class="p">,</span> <span class="n">MSG_CONFIRM_CARDS</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_DECK</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_HAND</span><span class="p">,</span>
            <span class="n">MSG_REFRESH_DECK</span><span class="p">,</span> <span class="n">MSG_SWAP_GRAVE_DECK</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_SET_CARD</span><span class="p">,</span> <span class="n">MSG_REVERSE_DECK</span><span class="p">,</span>
            <span class="n">MSG_DECK_TOP</span><span class="p">,</span> <span class="n">MSG_SHUFFLE_EXTRA</span><span class="p">,</span> <span class="n">MSG_NEW_TURN</span><span class="p">,</span> <span class="n">MSG_NEW_PHASE</span><span class="p">,</span> <span class="n">MSG_CONFIRM_EXTRATOP</span><span class="p">,</span>
            <span class="n">MSG_MOVE</span><span class="p">,</span> <span class="n">MSG_POS_CHANGE</span><span class="p">,</span> <span class="n">MSG_SET</span><span class="p">,</span> <span class="n">MSG_SWAP</span><span class="p">,</span> <span class="n">MSG_FIELD_DISABLED</span><span class="p">,</span>
            <span class="n">MSG_SUMMONING</span><span class="p">,</span> <span class="n">MSG_SUMMONED</span><span class="p">,</span> <span class="n">MSG_SPSUMMONING</span><span class="p">,</span> <span class="n">MSG_SPSUMMONED</span><span class="p">,</span>
            <span class="n">MSG_FLIPSUMMONING</span><span class="p">,</span> <span class="n">MSG_FLIPSUMMONED</span><span class="p">,</span> <span class="n">MSG_CHAINING</span><span class="p">,</span> <span class="n">MSG_CHAINED</span><span class="p">,</span>
            <span class="n">MSG_CHAIN_SOLVING</span><span class="p">,</span> <span class="n">MSG_CHAIN_SOLVED</span><span class="p">,</span> <span class="n">MSG_CHAIN_END</span><span class="p">,</span> <span class="n">MSG_CHAIN_NEGATED</span><span class="p">,</span> <span class="n">MSG_CHAIN_DISABLED</span><span class="p">,</span>
            <span class="n">MSG_CARD_SELECTED</span><span class="p">,</span> <span class="n">MSG_RANDOM_SELECTED</span><span class="p">,</span> <span class="n">MSG_BECOME_TARGET</span><span class="p">,</span>
            <span class="n">MSG_DRAW</span><span class="p">,</span> <span class="n">MSG_DAMAGE</span><span class="p">,</span> <span class="n">MSG_RECOVER</span><span class="p">,</span> <span class="n">MSG_EQUIP</span><span class="p">,</span> <span class="n">MSG_LPUPDATE</span><span class="p">,</span> <span class="n">MSG_UNEQUIP</span><span class="p">,</span>
            <span class="n">MSG_CARD_TARGET</span><span class="p">,</span> <span class="n">MSG_CANCEL_TARGET</span><span class="p">,</span> <span class="n">MSG_PAY_LPCOST</span><span class="p">,</span> <span class="n">MSG_ADD_COUNTER</span><span class="p">,</span> <span class="n">MSG_REMOVE_COUNTER</span><span class="p">,</span>
            <span class="n">MSG_ATTACK</span><span class="p">,</span> <span class="n">MSG_BATTLE</span><span class="p">,</span> <span class="n">MSG_ATTACK_DISABLED</span><span class="p">,</span> <span class="n">MSG_DAMAGE_STEP_START</span><span class="p">,</span> <span class="n">MSG_DAMAGE_STEP_END</span><span class="p">,</span>
            <span class="n">MSG_MISSED_EFFECT</span><span class="p">,</span> <span class="n">MSG_BE_CHAIN_TARGET</span><span class="p">,</span> <span class="n">MSG_CREATE_RELATION</span><span class="p">,</span> <span class="n">MSG_RELEASE_RELATION</span><span class="p">,</span>
            <span class="n">MSG_TOSS_COIN</span><span class="p">,</span> <span class="n">MSG_TOSS_DICE</span><span class="p">,</span> <span class="n">MSG_ROCK_PAPER_SCISSORS</span><span class="p">,</span> <span class="n">MSG_HAND_RES</span><span class="p">,</span>
            <span class="n">MSG_ANNOUNCE_RACE</span><span class="p">,</span> <span class="n">MSG_ANNOUNCE_ATTRIB</span><span class="p">,</span> <span class="n">MSG_ANNOUNCE_CARD</span><span class="p">,</span> <span class="n">MSG_ANNOUNCE_NUMBER</span><span class="p">,</span>
            <span class="n">MSG_CARD_HINT</span><span class="p">,</span> <span class="n">MSG_TAG_SWAP</span><span class="p">,</span> <span class="n">MSG_RELOAD_FIELD</span><span class="p">,</span> <span class="n">MSG_AI_NAME</span><span class="p">,</span> <span class="n">MSG_SHOW_HINT</span><span class="p">,</span> <span class="n">MSG_PLAYER_HINT</span><span class="p">,</span>
            <span class="n">MSG_MATCH_KILL</span><span class="p">,</span> <span class="n">MSG_CUSTOM_MSG</span><span class="p">,</span> <span class="n">MSG_REMOVE_CARDS</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_ITERATIONS</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_DuelProcess</span><span class="p">(</span><span class="n">duel</span><span class="p">)</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_messages</span><span class="p">(</span><span class="n">duel</span><span class="p">)</span>

            <span class="n">decision_found</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">msg_data</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>

                <span class="c1"># Skip informational messages</span>
                <span class="k">if</span> <span class="n">msg_type</span> <span class="ow">in</span> <span class="n">INFORMATIONAL</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_IDLE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_idle</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">)</span>
                    <span class="k">return</span>  <span class="c1"># Branching handled</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_CARD</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_select_card</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">)</span>
                    <span class="k">return</span>  <span class="c1"># Branching handled</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_CHAIN</span><span class="p">:</span>
                    <span class="c1"># Auto-decline chain (opponent has no responses)</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">build_decline_chain_response</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_DuelSetResponse</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
                    <span class="n">decision_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Continue processing - don&#39;t return, need to process more</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_PLACE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_select_place</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_POSITION</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_select_position</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">MSG_SELECT_EFFECTYN</span><span class="p">,</span> <span class="n">MSG_SELECT_YESNO</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_yes_no</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_OPTION</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_select_option</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_UNSELECT_CARD</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_select_unselect_card</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_SUM</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_select_sum</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_TRIBUTE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_select_tribute</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="c1"># Legacy message type - treat as yes/no or option selection</span>
                    <span class="c1"># Some ygopro-core versions use 12 for effect confirmation</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_legacy_message_12</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_RETRY</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RETRY: Invalid response at depth </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">))</span>
                    <span class="k">return</span>  <span class="c1"># Stop this path</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Unknown message type - log with name if known</span>
                    <span class="n">msg_name</span> <span class="o">=</span> <span class="n">MSG_TYPE_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msg_type</span><span class="p">,</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unhandled message type </span><span class="si">{</span><span class="n">msg_type</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">msg_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># DUEL_END</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_record_terminal</span><span class="p">(</span><span class="n">action_history</span><span class="p">,</span> <span class="s2">&quot;DUEL_END&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">decision_found</span><span class="p">:</span>  <span class="c1"># AWAITING but nothing handled</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AWAITING with no messages at depth </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="c1"># status == 2 means CONTINUE - keep processing</span>

    <span class="c1"># =========================================================================</span>
    <span class="c1"># MESSAGE HANDLERS</span>
    <span class="c1"># =========================================================================</span>
    <span class="c1"># These methods handle different message types from the engine.</span>
    <span class="c1"># Future refactoring: Extract to enumeration/handlers.py as a mixin class.</span>
    <span class="c1"># Blocked by: Circular import (handlers need Action dataclass from this file)</span>
    <span class="c1"># Solution: Move Action to a shared types module first.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span> <span class="n">idle_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle MSG_IDLE - branch on all actions + PASS.</span>

<span class="sd">        With intermediate state pruning enabled, we check if this exact game state</span>
<span class="sd">        (board + available actions) has been explored before. If so, we skip it</span>
<span class="sd">        since all future paths from this state are identical.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>

        <span class="c1"># Intermediate state pruning using transposition table</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedupe_intermediate</span><span class="p">:</span>
            <span class="c1"># Compute intermediate state hash</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">IntermediateState</span><span class="o">.</span><span class="n">from_engine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">idle_data</span><span class="p">,</span> <span class="n">capture_board_state</span><span class="p">)</span>
            <span class="n">state_hash</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span>

            <span class="c1"># Check transposition table</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transposition_table</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">state_hash</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_states_pruned</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PRUNED: duplicate intermediate state at depth </span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
                <span class="k">return</span>  <span class="c1"># Already explored from this state</span>

            <span class="c1"># Store in transposition table (will be updated with results later if needed)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transposition_table</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">state_hash</span><span class="p">,</span> <span class="n">TranspositionEntry</span><span class="p">(</span>
                <span class="n">state_hash</span><span class="o">=</span><span class="n">state_hash</span><span class="p">,</span>
                <span class="n">best_terminal_hash</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">best_terminal_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">creation_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                <span class="n">visit_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IDLE: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;activatable&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2"> activatable, &quot;</span>
                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spsummon&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2"> spsummon&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># Enumerate all activatable effects</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;activatable&quot;</span><span class="p">,</span> <span class="p">[])):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">get_card_name</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;desc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># desc format: (code &lt;&lt; 20) | effect_index</span>
            <span class="n">effect_idx</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">&amp;</span> <span class="mh">0xF</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">build_activate_response</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Location names for clearer descriptions</span>
            <span class="n">loc_name</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;hand&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;field&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="s2">&quot;S/T&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">:</span> <span class="s2">&quot;GY&quot;</span><span class="p">,</span> <span class="mi">64</span><span class="p">:</span> <span class="s2">&quot;Extra&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;loc</span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;ACTIVATE&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_IDLE</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Activate </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">loc_name</span><span class="si">}</span><span class="s2"> eff</span><span class="si">{</span><span class="n">effect_idx</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">card_code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                <span class="n">card_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: Activate </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">loc_name</span><span class="si">}</span><span class="s2"> eff</span><span class="si">{</span><span class="n">effect_idx</span><span class="si">}</span><span class="s2">) (idx </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

        <span class="c1"># Enumerate special summons</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spsummon&quot;</span><span class="p">,</span> <span class="p">[])):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">get_card_name</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span>  <span class="c1"># Special summon response</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SPSUMMON&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_IDLE</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Special Summon </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">card_code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                <span class="n">card_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: SpSummon </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (idx </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

        <span class="c1"># Enumerate normal summons</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summonable&quot;</span><span class="p">,</span> <span class="p">[])):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">get_card_name</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span>  <span class="c1"># Normal summon response</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SUMMON&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_IDLE</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Normal Summon </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">card_code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                <span class="n">card_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: Summon </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (idx </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

        <span class="c1"># PASS option (terminal)</span>
        <span class="k">if</span> <span class="n">idle_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;to_ep&quot;</span><span class="p">):</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">build_pass_response</span><span class="p">()</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;PASS&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_IDLE</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Pass (End Phase)&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: PASS (terminal)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_record_terminal</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">],</span> <span class="s2">&quot;PASS&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_select_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span> <span class="n">select_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle MSG_SELECT_CARD - branch on unique card codes only.</span>

<span class="sd">        Optimization: Selecting Holactie #1 vs Holactie #2 produces identical outcomes,</span>
<span class="sd">        so we deduplicate by card code and only branch on the first instance of each.</span>
<span class="sd">        This reduces branching significantly (e.g., 5 Holacties -&gt; 1 branch instead of 5).</span>

<span class="sd">        Card Prioritization: If prioritize_cards is set, those cards are explored first</span>
<span class="sd">        in the order specified. This ensures specific combo paths are explored before</span>
<span class="sd">        the search budget is exhausted.</span>

<span class="sd">        SELECT_SUM_CANCEL Backtracking: If a SELECT_CARD choice led to SELECT_SUM_CANCEL,</span>
<span class="sd">        we exclude that card from subsequent SELECT_CARD prompts in the same path. This</span>
<span class="sd">        prevents degenerate loops where DFS repeatedly selects a card whose materials</span>
<span class="sd">        can&#39;t be satisfied.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="n">select_data</span><span class="p">[</span><span class="s2">&quot;cards&quot;</span><span class="p">]</span>
        <span class="n">min_sel</span> <span class="o">=</span> <span class="n">select_data</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span>
        <span class="n">max_sel</span> <span class="o">=</span> <span class="n">select_data</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT_CARD: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cards</span><span class="p">)</span><span class="si">}</span><span class="s2"> cards, select </span><span class="si">{</span><span class="n">min_sel</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">max_sel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># Compute context hash for this SELECT_CARD prompt</span>
        <span class="n">context_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_select_card_context</span><span class="p">(</span><span class="n">select_data</span><span class="p">)</span>

        <span class="c1"># Method 1: Find cards that led to SELECT_SUM_CANCEL in this path</span>
        <span class="c1"># Pattern: SELECT_CARD(code X) followed by SELECT_SUM_CANCEL</span>
        <span class="n">failed_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">action_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">next_action</span> <span class="o">=</span> <span class="n">action_history</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;SELECT_CARD&quot;</span> <span class="ow">and</span>
                <span class="n">next_action</span><span class="o">.</span><span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;SELECT_SUM_CANCEL&quot;</span> <span class="ow">and</span>
                <span class="n">action</span><span class="o">.</span><span class="n">card_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">failed_codes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">card_code</span><span class="p">)</span>

        <span class="c1"># Method 2: Get context-based failed codes (persistent across paths)</span>
        <span class="c1"># NOTE: This is disabled for now as it can be too aggressive</span>
        <span class="c1"># The action_history based tracking (Method 1) is more precise</span>
        <span class="c1"># context_failed = self._get_failed_cards_at_context(context_hash)</span>
        <span class="c1"># failed_codes.update(context_failed)</span>

        <span class="k">if</span> <span class="n">failed_codes</span><span class="p">:</span>
            <span class="n">failed_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_card_name</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">failed_codes</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Excluding failed SELECT_SUM cards: </span><span class="si">{</span><span class="n">failed_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># For simplicity, enumerate single selections if min==max==1</span>
        <span class="k">if</span> <span class="n">min_sel</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">max_sel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Build list of (index, code) pairs, deduplicating by code</span>
            <span class="n">unique_cards</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">seen_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cards</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">seen_codes</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># Skip cards that led to SELECT_SUM_CANCEL in this path</span>
                <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">failed_codes</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">seen_codes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                <span class="n">unique_cards</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span>

            <span class="c1"># Sort to put prioritized cards first</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prioritize_cards</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">priority_key</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                    <span class="n">idx</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prioritize_cards</span><span class="p">:</span>
                        <span class="c1"># Prioritized cards come first, in the order specified</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prioritize_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">999</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>  <span class="c1"># Non-prioritized cards keep original order</span>
                <span class="n">unique_cards</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">priority_key</span><span class="p">)</span>

            <span class="c1"># Branch on each unique card (now in priority order)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">unique_cards</span><span class="p">:</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">get_card_name</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                <span class="n">indices</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">build_select_card_response</span><span class="p">([</span><span class="n">i</span><span class="p">])</span>

                <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                    <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_CARD&quot;</span><span class="p">,</span>
                    <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_CARD</span><span class="p">,</span>
                    <span class="n">response_value</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
                    <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Select </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">card_code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                    <span class="n">card_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">context_hash</span><span class="o">=</span><span class="n">context_hash</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: Select </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (idx </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_cards</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multi-select: enumerate combinations of unique card codes</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>

            <span class="c1"># Group cards by code, keeping first index for each</span>
            <span class="n">code_to_indices</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cards</span><span class="p">):</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span>
                <span class="c1"># Skip cards that led to SELECT_SUM_CANCEL in this path</span>
                <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">failed_codes</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">code_to_indices</span><span class="p">:</span>
                    <span class="n">code_to_indices</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">code_to_indices</span><span class="p">[</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">unique_codes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">code_to_indices</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">min_sel</span><span class="p">,</span> <span class="n">max_sel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">code_combo</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">unique_codes</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
                    <span class="c1"># Use first index for each selected code</span>
                    <span class="n">combo</span> <span class="o">=</span> <span class="p">[</span><span class="n">code_to_indices</span><span class="p">[</span><span class="n">code</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_combo</span><span class="p">]</span>
                    <span class="n">indices</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">build_select_card_response</span><span class="p">(</span><span class="n">combo</span><span class="p">)</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_card_name</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_combo</span><span class="p">]</span>

                    <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                        <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_CARD&quot;</span><span class="p">,</span>
                        <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_CARD</span><span class="p">,</span>
                        <span class="n">response_value</span><span class="o">=</span><span class="n">combo</span><span class="p">,</span>
                        <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Select </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: Select </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_select_place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle MSG_SELECT_PLACE - select zone for card.&quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>

        <span class="c1"># msg_data format: player(1) + count(1) + flag(4)</span>
        <span class="c1"># Flag bits indicate occupied zones; we need to find a free one</span>
        <span class="n">player</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;player&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT_PLACE: flag=0x</span><span class="si">{</span><span class="n">flag</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># Find first available zone</span>
        <span class="c1"># S/T zone bits: 8-12 (flag &amp; (1 &lt;&lt; (8 + i)))</span>
        <span class="c1"># Monster zone bits: 0-4 (flag &amp; (1 &lt;&lt; i))</span>
        <span class="n">location</span> <span class="o">=</span> <span class="mh">0x08</span>  <span class="c1"># S/T zone first</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i</span><span class="p">))):</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No S/T zone available, try monster zone</span>
            <span class="n">location</span> <span class="o">=</span> <span class="mh">0x04</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)):</span>
                    <span class="n">sequence</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">break</span>

        <span class="c1"># Response format: player(1) + location(1) + sequence(1) = 3 bytes</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;BBB&quot;</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
            <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_PLACE&quot;</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_PLACE</span><span class="p">,</span>
            <span class="n">response_value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;zone_</span><span class="si">{</span><span class="n">location</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Select zone (</span><span class="si">{</span><span class="n">location</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">sequence</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_select_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle MSG_SELECT_POSITION - always select ATK.</span>

<span class="sd">        Analysis showed position choices don&#39;t affect final board states</span>
<span class="sd">        for this library, so we skip branching to reduce search space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>  <span class="c1"># ATK position</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
            <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_POSITION&quot;</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_POSITION</span><span class="p">,</span>
            <span class="n">response_value</span><span class="o">=</span><span class="mh">0x1</span><span class="p">,</span>
            <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Position: ATK (auto)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_yes_no</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle yes/no prompts - branch on both options.&quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">choice</span><span class="p">,</span> <span class="n">choice_name</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Yes&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">)]:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;YES_NO&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">msg_type</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">choice</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Choose: </span><span class="si">{</span><span class="n">choice_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: </span><span class="si">{</span><span class="n">choice_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_select_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle MSG_SELECT_OPTION - select from multiple options.&quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg_data</span> <span class="k">else</span> <span class="mi">2</span>  <span class="c1"># Fallback to 2 if parsing failed</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;options&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">msg_data</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT_OPTION: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> options available&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">opt</span><span class="p">][</span><span class="s2">&quot;desc&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">opt</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_OPTION&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_OPTION</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Option </span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2"> (desc=</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: Option </span><span class="si">{</span><span class="n">opt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_select_unselect_card</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle MSG_SELECT_UNSELECT_CARD - select/unselect cards.</span>

<span class="sd">        Optimization: Deduplicate by card code to avoid redundant branches</span>
<span class="sd">        when selecting identical cards (e.g., multiple Holacties).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>
        <span class="n">finishable</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;finishable&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">select_cards</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;select_cards&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">unselect_cards</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unselect_cards&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT_UNSELECT: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">select_cards</span><span class="p">)</span><span class="si">}</span><span class="s2"> select, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unselect_cards</span><span class="p">)</span><span class="si">}</span><span class="s2"> unselect, finishable=</span><span class="si">{</span><span class="n">finishable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># If finishable and we have unselect options, we can finish</span>
        <span class="k">if</span> <span class="n">finishable</span> <span class="ow">and</span> <span class="n">unselect_cards</span><span class="p">:</span>
            <span class="c1"># Response -1 (signed int32) signals finish per ygopro-core</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;i&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_UNSELECT_FINISH&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_UNSELECT_CARD</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Finish selection&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: Finish selection&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

        <span class="c1"># Enumerate selectable cards - deduplicate by card code</span>
        <span class="n">seen_codes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">select_cards</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">seen_codes</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Skip duplicate card instances</span>
            <span class="n">seen_codes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">get_card_name</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="c1"># Response is just the index (single int32) per ygopro-core field_processor.cpp</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;i&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_UNSELECT_SELECT&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_UNSELECT_CARD</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Select </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">card_code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                <span class="n">card_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: Select </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">seen_codes</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_select_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle MSG_SELECT_SUM - select cards whose levels sum to target.</span>

<span class="sd">        Used for Xyz summon material selection, Synchro tuning, and similar mechanics.</span>

<span class="sd">        Response format (per ygopro-core playerop.cpp parse_response_cards):</span>
<span class="sd">        - int32_t type: -1 to cancel (if allowed), 0 for 32-bit indices</span>
<span class="sd">        - uint32_t count: number of selected cards (if type != -1)</span>
<span class="sd">        - uint32_t indices[count]: 0-indexed positions in the selectable cards</span>

<span class="sd">        This handler enumerates ALL valid sum combinations to explore all possible</span>
<span class="sd">        Xyz/Synchro lines, not just the first valid selection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>
        
        <span class="c1"># Extract parsed data</span>
        <span class="n">must_select</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;must_select&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">can_select</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;can_select&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">target_sum</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_sum&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">must_count</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;must_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">can_count</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;can_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">select_mode</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;select_mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">min_cards</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">max_cards</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">can_select</span><span class="p">)</span> <span class="k">if</span> <span class="n">can_select</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">mode_str</span> <span class="o">=</span> <span class="s2">&quot;exact&quot;</span> <span class="k">if</span> <span class="n">select_mode</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;at_least&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT_SUM: target=</span><span class="si">{</span><span class="n">target_sum</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">mode_str</span><span class="si">}</span><span class="s2">), select </span><span class="si">{</span><span class="n">min_cards</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">max_cards</span><span class="si">}</span><span class="s2"> cards&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># DEBUG: Always show raw hex for analysis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="s2">&quot;_raw_hex&quot;</span> <span class="ow">in</span> <span class="n">msg_data</span><span class="p">:</span>
            <span class="n">raw_hex</span> <span class="o">=</span> <span class="n">msg_data</span><span class="p">[</span><span class="s1">&#39;_raw_hex&#39;</span><span class="p">]</span>
            <span class="n">raw_len</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_raw_len&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_hex</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  RAW (</span><span class="si">{</span><span class="n">raw_len</span><span class="si">}</span><span class="s2"> bytes): </span><span class="si">{</span><span class="n">raw_hex</span><span class="p">[:</span><span class="mi">80</span><span class="p">]</span><span class="si">}{</span><span class="s1">&#39;...&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">raw_hex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="c1"># Show first card&#39;s bytes (offset 15, 18 bytes per card)</span>
            <span class="c1"># Format: code(4) + controller(1) + location(1) + sequence(4) + position(4) + sum_param(4)</span>
            <span class="k">if</span> <span class="n">raw_len</span> <span class="o">&gt;=</span> <span class="mi">33</span><span class="p">:</span>  <span class="c1"># 15 header + 18 card bytes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Card0 bytes (offset 15): </span><span class="si">{</span><span class="n">raw_hex</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">66</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># Check for parse errors</span>
        <span class="k">if</span> <span class="s2">&quot;_parse_error&quot;</span> <span class="ow">in</span> <span class="n">msg_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  PARSE ERROR: </span><span class="si">{</span><span class="n">msg_data</span><span class="p">[</span><span class="s1">&#39;_parse_error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># Debug: show available cards with their levels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">must_select</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">get_card_name</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  must[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> level=</span><span class="si">{</span><span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> (sum_param=0x</span><span class="si">{</span><span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sum_param&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">can_select</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">get_card_name</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  can[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> level=</span><span class="si">{</span><span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> (sum_param=0x</span><span class="si">{</span><span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sum_param&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># Branch 1: Cancel the selection (valid for optional effects)</span>
        <span class="c1"># Many Fiendsmith effects are optional, so canceling is a valid path</span>
        <span class="c1">#</span>
        <span class="c1"># CRITICAL: Mark the preceding SELECT_CARD choice as failed at its context</span>
        <span class="c1"># This prevents infinite loops when the engine re-prompts the same SELECT_CARD</span>
        <span class="n">last_select_card</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">action_history</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">action_type</span> <span class="o">==</span> <span class="s2">&quot;SELECT_CARD&quot;</span> <span class="ow">and</span> <span class="n">action</span><span class="o">.</span><span class="n">card_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">last_select_card</span> <span class="o">=</span> <span class="n">action</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">last_select_card</span> <span class="ow">and</span> <span class="n">last_select_card</span><span class="o">.</span><span class="n">context_hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mark_card_failed_at_context</span><span class="p">(</span>
                <span class="n">last_select_card</span><span class="o">.</span><span class="n">context_hash</span><span class="p">,</span>
                <span class="n">last_select_card</span><span class="o">.</span><span class="n">card_code</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Marked </span><span class="si">{</span><span class="n">last_select_card</span><span class="o">.</span><span class="n">card_name</span><span class="si">}</span><span class="s2"> as failed at context </span><span class="si">{</span><span class="n">last_select_card</span><span class="o">.</span><span class="n">context_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="n">cancel_response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;i&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cancel_action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
            <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_SUM_CANCEL&quot;</span><span class="p">,</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_SUM</span><span class="p">,</span>
            <span class="n">response_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">response_bytes</span><span class="o">=</span><span class="n">cancel_response</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Cancel sum selection&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: Cancel sum selection&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">cancel_action</span><span class="p">])</span>

        <span class="c1"># Branch 2+: Find and explore all valid sum combinations</span>
        <span class="c1"># For Xyz: need cards whose levels sum to target (e.g., 2x Level 6 = 12)</span>

        <span class="c1"># Handle case where target_sum seems to be number of cards, not level sum</span>
        <span class="c1"># The ygopro-core format varies - target may be:</span>
        <span class="c1"># 1. Actual level sum (e.g., 12 for 2x Level 6)</span>
        <span class="c1"># 2. Number of cards to select (e.g., 2 for 2 materials)</span>
        <span class="c1"># 3. Something else encoded</span>
        <span class="n">actual_target</span> <span class="o">=</span> <span class="n">target_sum</span>
        <span class="k">if</span> <span class="n">can_select</span> <span class="ow">and</span> <span class="n">target_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">first_card_value</span> <span class="o">=</span> <span class="n">can_select</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># If target matches number of cards and cards have consistent values,</span>
            <span class="c1"># treat target as card count and compute sum</span>
            <span class="k">if</span> <span class="n">target_sum</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">can_select</span><span class="p">)</span> <span class="ow">and</span> <span class="n">first_card_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">expected_sum</span> <span class="o">=</span> <span class="n">first_card_value</span> <span class="o">*</span> <span class="n">target_sum</span>
                <span class="c1"># Use the computed sum if it makes sense</span>
                <span class="n">actual_target</span> <span class="o">=</span> <span class="n">expected_sum</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Adjusted target: </span><span class="si">{</span><span class="n">target_sum</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">actual_target</span><span class="si">}</span><span class="s2"> (card_value=</span><span class="si">{</span><span class="n">first_card_value</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="n">valid_combos</span> <span class="o">=</span> <span class="n">find_valid_sum_combinations</span><span class="p">(</span>
            <span class="n">must_select</span><span class="o">=</span><span class="n">must_select</span><span class="p">,</span>
            <span class="n">can_select</span><span class="o">=</span><span class="n">can_select</span><span class="p">,</span>
            <span class="n">target_sum</span><span class="o">=</span><span class="n">actual_target</span><span class="p">,</span>
            <span class="n">min_select</span><span class="o">=</span><span class="n">min_cards</span><span class="p">,</span>
            <span class="n">max_select</span><span class="o">=</span><span class="n">max_cards</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">select_mode</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_combos</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid sum combinations&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
        
        <span class="c1"># Deduplicate combinations by card codes to avoid redundant branches</span>
        <span class="c1"># (selecting Token A + Requiem vs Token B + Requiem with same codes)</span>
        <span class="n">seen_code_combos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">combo_indices</span> <span class="ow">in</span> <span class="n">valid_combos</span><span class="p">:</span>
            <span class="c1"># Get card codes for this combination</span>
            <span class="n">combo_codes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">can_select</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">combo_indices</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">combo_codes</span> <span class="ow">in</span> <span class="n">seen_code_combos</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Skip duplicate code combination</span>
            <span class="n">seen_code_combos</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">combo_codes</span><span class="p">)</span>
            
            <span class="c1"># Build response for MSG_SELECT_SUM</span>
            <span class="c1"># Response format (from ygopro-core playerop.cpp parse_response_cards):</span>
            <span class="c1"># - int32_t type (0 = u32 indices, 1 = u16 indices, 3 = bitfield)</span>
            <span class="c1"># - For type 0: uint32_t count + uint32_t indices[]</span>
            <span class="n">full_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combo_indices</span><span class="p">)</span>

            <span class="c1"># Format: i32(type=0) + u32(count) + u32[] indices</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_indices</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;iI&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">full_indices</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

            <span class="c1"># Debug: show exact response bytes</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">hex_resp</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SELECT_SUM response (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes): </span><span class="si">{</span><span class="n">hex_resp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Indices: </span><span class="si">{</span><span class="n">full_indices</span><span class="si">}</span><span class="s2"> (can_select has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">can_select</span><span class="p">)</span><span class="si">}</span><span class="s2"> cards)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

            <span class="c1"># Build description</span>
            <span class="n">card_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_card_name</span><span class="p">(</span><span class="n">can_select</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">combo_indices</span><span class="p">]</span>
            <span class="n">total_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">can_select</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">combo_indices</span><span class="p">)</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Sum select: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">card_names</span><span class="p">)</span><span class="si">}</span><span class="s2"> (sum=</span><span class="si">{</span><span class="n">total_sum</span><span class="si">}</span><span class="s2">)&quot;</span>
            
            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_SUM&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_SUM</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">full_indices</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>
        
        <span class="c1"># If no valid combinations found and cancel didn&#39;t work, try index 0 as fallback</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_combos</span> <span class="ow">and</span> <span class="n">can_select</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  No valid combos, trying fallback (index 0)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="c1"># Format: i32(type=0) + u32(count) + u32 index (same as valid selections)</span>
            <span class="n">fallback_response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;iII&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">fallback_action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_SUM_FALLBACK&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_SUM</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">fallback_response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sum select fallback: card 0&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">fallback_action</span><span class="p">])</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_select_tribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle MSG_SELECT_TRIBUTE - enumerate all valid tribute combinations.&quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>

        <span class="n">cards</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cards&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">min_req</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">max_req</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cancelable</span> <span class="o">=</span> <span class="n">msg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cancelable&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT_TRIBUTE: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cards</span><span class="p">)</span><span class="si">}</span><span class="s2"> cards, need </span><span class="si">{</span><span class="n">min_req</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">max_req</span><span class="si">}</span><span class="s2"> tributes&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># Debug: show available cards</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">get_card_name</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  [</span><span class="si">{</span><span class="n">card</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (release_param=</span><span class="si">{</span><span class="n">card</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;release_param&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Find all valid tribute combinations</span>
        <span class="n">valid_combos</span> <span class="o">=</span> <span class="n">find_valid_tribute_combinations</span><span class="p">(</span><span class="n">cards</span><span class="p">,</span> <span class="n">min_req</span><span class="p">,</span> <span class="n">max_req</span><span class="p">)</span>

        <span class="c1"># Deduplicate by card codes to avoid redundant branches</span>
        <span class="n">seen_code_combos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">valid_combos</span><span class="p">:</span>
            <span class="n">combo_codes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">combo</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">combo_codes</span> <span class="ow">in</span> <span class="n">seen_code_combos</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen_code_combos</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">combo_codes</span><span class="p">)</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">build_select_tribute_response</span><span class="p">(</span><span class="n">combo</span><span class="p">)</span>
            <span class="n">card_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_card_name</span><span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">combo</span><span class="p">]</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tribute </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">combo</span><span class="p">)</span><span class="si">}</span><span class="s2"> card(s): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">card_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_TRIBUTE&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_TRIBUTE</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">combo</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

        <span class="c1"># If cancelable, add cancel option</span>
        <span class="k">if</span> <span class="n">cancelable</span><span class="p">:</span>
            <span class="n">cancel_response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;B&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">cancel_action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_TRIBUTE_CANCEL&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_TRIBUTE</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">cancel_response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Cancel tribute&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: Cancel tribute&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">cancel_action</span><span class="p">])</span>

        <span class="c1"># Fallback if no valid combos found</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_combos</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cancelable</span> <span class="ow">and</span> <span class="n">cards</span><span class="p">:</span>
            <span class="n">fallback_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">min_req</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cards</span><span class="p">))))</span>
            <span class="n">fallback_response</span> <span class="o">=</span> <span class="n">build_select_tribute_response</span><span class="p">(</span><span class="n">fallback_indices</span><span class="p">)</span>
            <span class="n">fallback_action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;SELECT_TRIBUTE_FALLBACK&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">MSG_SELECT_TRIBUTE</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">fallback_indices</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">fallback_response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Fallback: tribute first </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fallback_indices</span><span class="p">)</span><span class="si">}</span><span class="s2"> cards&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: Fallback tribute&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">fallback_action</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_legacy_message_12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">,</span> <span class="n">action_history</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle legacy message type 12.</span>

<span class="sd">        In some ygopro-core versions, message 12 is used for effect activation prompts.</span>
<span class="sd">        We treat it similar to yes/no but with simpler parsing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Legacy MSG 12 at depth </span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="c1"># Try both yes (1) and no (0) options like yes/no handler</span>
        <span class="k">for</span> <span class="n">choice</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;I&quot;</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>
            <span class="n">choice_name</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">choice</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">Action</span><span class="p">(</span>
                <span class="n">action_type</span><span class="o">=</span><span class="s2">&quot;LEGACY_12&quot;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">response_value</span><span class="o">=</span><span class="n">choice</span><span class="p">,</span>
                <span class="n">response_bytes</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Legacy choice: </span><span class="si">{</span><span class="n">choice_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Branch: </span><span class="si">{</span><span class="n">choice_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">(</span><span class="n">action_history</span> <span class="o">+</span> <span class="p">[</span><span class="n">action</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all pending messages from engine.&quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">length</span> <span class="o">=</span> <span class="n">ffi</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;uint32_t*&quot;</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_DuelGetMessage</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">messages</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">ffi</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># Each message has length prefix</span>
            <span class="k">if</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">msg_len</span> <span class="o">=</span> <span class="n">read_u32</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">msg_start</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">msg_type</span> <span class="o">=</span> <span class="n">read_u8</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

            <span class="c1"># Read message body</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="n">msg_len</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Already read msg_type</span>
            <span class="n">msg_body</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_IDLE</span><span class="p">:</span>
                <span class="n">msg_data</span> <span class="o">=</span> <span class="n">parse_idle</span><span class="p">(</span><span class="n">msg_body</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">MSG_IDLE</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_CARD</span><span class="p">:</span>
                <span class="n">msg_data</span> <span class="o">=</span> <span class="n">parse_select_card</span><span class="p">(</span><span class="n">msg_body</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">MSG_SELECT_CARD</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_CHAIN</span><span class="p">:</span>
                <span class="n">msg_data</span> <span class="o">=</span> <span class="n">parse_select_chain</span><span class="p">(</span><span class="n">msg_body</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">MSG_SELECT_CHAIN</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_PLACE</span><span class="p">:</span>
                <span class="n">msg_data</span> <span class="o">=</span> <span class="n">parse_select_place</span><span class="p">(</span><span class="n">msg_body</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">MSG_SELECT_PLACE</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_UNSELECT_CARD</span><span class="p">:</span>
                <span class="n">msg_data</span> <span class="o">=</span> <span class="n">parse_select_unselect_card</span><span class="p">(</span><span class="n">msg_body</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">MSG_SELECT_UNSELECT_CARD</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_OPTION</span><span class="p">:</span>
                <span class="n">msg_data</span> <span class="o">=</span> <span class="n">parse_select_option</span><span class="p">(</span><span class="n">msg_body</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">MSG_SELECT_OPTION</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_SUM</span><span class="p">:</span>
                <span class="n">msg_data</span> <span class="o">=</span> <span class="n">parse_select_sum</span><span class="p">(</span><span class="n">msg_body</span><span class="p">)</span>
                <span class="n">msg_data</span><span class="p">[</span><span class="s2">&quot;_raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg_body</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>  <span class="c1"># Debug: include raw bytes</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">MSG_SELECT_SUM</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="n">MSG_SELECT_TRIBUTE</span><span class="p">:</span>
                <span class="n">msg_data</span> <span class="o">=</span> <span class="n">parse_select_tribute</span><span class="p">(</span><span class="n">msg_body</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">MSG_SELECT_TRIBUTE</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">msg_type</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
                <span class="c1"># Legacy message type - pass raw data for handler</span>
                <span class="n">msg_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="n">msg_body</span><span class="p">}</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span> <span class="n">msg_data</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Unhandled message type</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">msg_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">messages</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_record_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_history</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Action</span><span class="p">],</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record a terminal state with full board capture.</span>

<span class="sd">        If dedupe_boards is enabled, skips recording if we&#39;ve already</span>
<span class="sd">        seen an identical board state (reached via a different path).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create state hash from action sequence</span>
        <span class="n">action_str</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">description</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">action_history</span><span class="p">)</span>
        <span class="n">state_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">action_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>

        <span class="c1"># Capture board state by replaying actions</span>
        <span class="n">board_state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">action_history</span><span class="p">:</span>
            <span class="n">duel</span> <span class="o">=</span> <span class="n">create_duel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_deck</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_deck</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_StartDuel</span><span class="p">(</span><span class="n">duel</span><span class="p">)</span>
                <span class="c1"># Replay all actions</span>
                <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">action_history</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_replay_action</span><span class="p">(</span><span class="n">duel</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
                <span class="c1"># Capture the final board state</span>
                <span class="n">board_state</span> <span class="o">=</span> <span class="n">capture_board_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="p">,</span> <span class="n">duel</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Board capture failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">OCG_DestroyDuel</span><span class="p">(</span><span class="n">duel</span><span class="p">)</span>

        <span class="c1"># Check for duplicate board state using BoardSignature</span>
        <span class="n">board_hash</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">board_state</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">BoardSignature</span><span class="o">.</span><span class="n">from_board_state</span><span class="p">(</span><span class="n">board_state</span><span class="p">)</span>
            <span class="n">board_hash</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">hash</span><span class="p">()</span>

            <span class="c1"># Group by board signature</span>
            <span class="k">if</span> <span class="n">board_hash</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_boards</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">terminal_boards</span><span class="p">[</span><span class="n">board_hash</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminal_boards</span><span class="p">[</span><span class="n">board_hash</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dedupe_boards</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">board_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen_board_sigs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">duplicate_boards_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SKIPPED duplicate board at depth </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>  <span class="c1"># Skip recording this duplicate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seen_board_sigs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">board_hash</span><span class="p">)</span>

        <span class="n">terminal</span> <span class="o">=</span> <span class="n">TerminalState</span><span class="p">(</span>
            <span class="n">action_sequence</span><span class="o">=</span><span class="n">action_history</span><span class="p">,</span>
            <span class="n">board_state</span><span class="o">=</span><span class="n">board_state</span><span class="p">,</span>
            <span class="n">depth</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">),</span>
            <span class="n">state_hash</span><span class="o">=</span><span class="n">state_hash</span><span class="p">,</span>
            <span class="n">termination_reason</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
            <span class="n">board_hash</span><span class="o">=</span><span class="n">board_hash</span><span class="p">,</span>  <span class="c1"># Add board hash for reference</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">terminals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">terminal</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="c1"># Show board summary</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">board_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;player0&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">monsters</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;monsters&quot;</span><span class="p">,</span> <span class="p">[])]</span>
            <span class="n">gy</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;graveyard&quot;</span><span class="p">,</span> <span class="p">[])]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  TERMINAL [</span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">] depth=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;Field=</span><span class="si">{</span><span class="n">monsters</span><span class="si">}</span><span class="s2">, GY=</span><span class="si">{</span><span class="n">gy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1"># PARALLEL WORKER ENTRY POINT</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="enumerate_from_hand">
<a class="viewcode-back" href="../../../modules/combo_enumeration.html#src.ygo_combo.combo_enumeration.enumerate_from_hand">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">enumerate_from_hand</span><span class="p">(</span>
    <span class="n">hand</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">deck</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
    <span class="n">max_paths</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumerate all combos from a specific starting hand.</span>

<span class="sd">    This is the worker-compatible entry point for parallel enumeration.</span>
<span class="sd">    Creates a fresh engine context, sets up the hand, and runs DFS.</span>

<span class="sd">    Args:</span>
<span class="sd">        hand: Tuple of card passcodes for starting hand.</span>
<span class="sd">        deck: Full deck list (for extra deck setup).</span>
<span class="sd">        max_depth: Maximum search depth.</span>
<span class="sd">        max_paths: Maximum paths to explore (0 = unlimited).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict with:</span>
<span class="sd">            - terminal_hashes: List of unique terminal board hashes</span>
<span class="sd">            - best_score: Highest board evaluation score</span>
<span class="sd">            - paths_explored: Number of paths explored</span>
<span class="sd">            - max_depth_reached: Deepest point in search tree</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">terminal_hashes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">best_score</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">paths_explored</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_depth_reached</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Create transposition table for this hand</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">TranspositionTable</span><span class="p">(</span><span class="n">max_size</span><span class="o">=</span><span class="mi">100_000</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Placeholder: actual enumeration logic goes here</span>
        <span class="c1"># For now, return empty results</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: Implement full enumeration with specific hand setup:</span>
        <span class="c1"># 1. Create duel with exact hand cards (not random draw)</span>
        <span class="c1"># 2. Run DFS enumeration from that state</span>
        <span class="c1"># 3. Collect terminal board hashes and scores</span>
        <span class="c1"># 4. Return serializable results</span>
        <span class="k">pass</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enumeration error for hand </span><span class="si">{</span><span class="n">hand</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;terminal_hashes&quot;</span><span class="p">:</span> <span class="n">terminal_hashes</span><span class="p">,</span>
        <span class="s2">&quot;best_score&quot;</span><span class="p">:</span> <span class="n">best_score</span><span class="p">,</span>
        <span class="s2">&quot;paths_explored&quot;</span><span class="p">:</span> <span class="n">paths_explored</span><span class="p">,</span>
        <span class="s2">&quot;max_depth_reached&quot;</span><span class="p">:</span> <span class="n">max_depth_reached</span><span class="p">,</span>
    <span class="p">}</span></div>



<span class="c1"># =============================================================================</span>
<span class="c1"># MAIN</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../modules/combo_enumeration.html#src.ygo_combo.combo_enumeration.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">MAX_DEPTH</span><span class="p">,</span> <span class="n">MAX_PATHS</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>

    <span class="c1"># Register signal handlers for graceful shutdown</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">_signal_handler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">_signal_handler</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Exhaustive combo enumeration&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Verbose output&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--max-depth&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">MAX_DEPTH</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Max actions per path&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--max-paths&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">MAX_PATHS</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Max paths to explore&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;enumeration_results.json&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output file&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no-dedupe&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable terminal board state deduplication&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no-dedupe-intermediate&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable intermediate state pruning&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--prioritize-cards&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Comma-separated list of card passcodes to explore first during SELECT_CARD&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Parse prioritized cards</span>
    <span class="n">prioritize_cards</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">prioritize_cards</span><span class="p">:</span>
        <span class="n">prioritize_cards</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">prioritize_cards</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">prioritize_cards</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Card prioritization enabled: </span><span class="si">{</span><span class="n">prioritize_cards</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Update limits</span>
    <span class="n">MAX_DEPTH</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">max_depth</span>
    <span class="n">MAX_PATHS</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">max_paths</span>

    <span class="c1"># Initialize</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading card database...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">init_card_database</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to load card database&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading library...&quot;</span><span class="p">)</span>
    <span class="n">lib</span> <span class="o">=</span> <span class="n">load_library</span><span class="p">()</span>

    <span class="c1"># Set the library reference for callbacks in engine_interface</span>
    <span class="n">set_lib</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading locked library...&quot;</span><span class="p">)</span>
    <span class="n">library</span> <span class="o">=</span> <span class="n">load_locked_library</span><span class="p">()</span>
    <span class="n">main_deck</span><span class="p">,</span> <span class="n">extra_deck</span> <span class="o">=</span> <span class="n">get_deck_lists</span><span class="p">(</span><span class="n">library</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Main deck: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">main_deck</span><span class="p">)</span><span class="si">}</span><span class="s2"> cards&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extra deck: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">extra_deck</span><span class="p">)</span><span class="si">}</span><span class="s2"> cards&quot;</span><span class="p">)</span>

    <span class="c1"># Run enumeration</span>
    <span class="n">dedupe_terminals</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_dedupe</span>
    <span class="n">dedupe_intermediate</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_dedupe_intermediate</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">EnumerationEngine</span><span class="p">(</span>
        <span class="n">lib</span><span class="p">,</span> <span class="n">main_deck</span><span class="p">,</span> <span class="n">extra_deck</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
        <span class="n">dedupe_boards</span><span class="o">=</span><span class="n">dedupe_terminals</span><span class="p">,</span>
        <span class="n">dedupe_intermediate</span><span class="o">=</span><span class="n">dedupe_intermediate</span><span class="p">,</span>
        <span class="n">prioritize_cards</span><span class="o">=</span><span class="n">prioritize_cards</span> <span class="k">if</span> <span class="n">prioritize_cards</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">terminals</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">enumerate_all</span><span class="p">()</span>

    <span class="c1"># Save results</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="n">tt_stats</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">transposition_table</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="n">MAX_DEPTH</span><span class="p">,</span>
            <span class="s2">&quot;max_paths&quot;</span><span class="p">:</span> <span class="n">MAX_PATHS</span><span class="p">,</span>
            <span class="s2">&quot;paths_explored&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">paths_explored</span><span class="p">,</span>
            <span class="s2">&quot;terminals_found&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">terminals</span><span class="p">),</span>
            <span class="s2">&quot;unique_board_signatures&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">terminal_boards</span><span class="p">),</span>
            <span class="s2">&quot;duplicate_boards_skipped&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">duplicate_boards_skipped</span><span class="p">,</span>
            <span class="s2">&quot;intermediate_states_pruned&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">intermediate_states_pruned</span><span class="p">,</span>
            <span class="s2">&quot;transposition_table_size&quot;</span><span class="p">:</span> <span class="n">tt_stats</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span>
            <span class="s2">&quot;transposition_hit_rate&quot;</span><span class="p">:</span> <span class="n">tt_stats</span><span class="p">[</span><span class="s2">&quot;hit_rate&quot;</span><span class="p">],</span>
            <span class="s2">&quot;dedupe_terminals_enabled&quot;</span><span class="p">:</span> <span class="n">dedupe_terminals</span><span class="p">,</span>
            <span class="s2">&quot;dedupe_intermediate_enabled&quot;</span><span class="p">:</span> <span class="n">dedupe_intermediate</span><span class="p">,</span>
            <span class="s2">&quot;prioritize_cards&quot;</span><span class="p">:</span> <span class="n">prioritize_cards</span> <span class="k">if</span> <span class="n">prioritize_cards</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s2">&quot;max_depth_seen&quot;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">max_depth_seen</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;terminals&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">terminals</span><span class="p">],</span>
        <span class="s2">&quot;board_groups&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">terminal_boards</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
    <span class="p">}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Results saved to: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Print summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SUMMARY&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

    <span class="n">by_reason</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">by_depth</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">terminals</span><span class="p">:</span>
        <span class="n">by_reason</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">termination_reason</span><span class="p">]</span> <span class="o">=</span> <span class="n">by_reason</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">termination_reason</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">by_depth</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">by_depth</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">By termination reason:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">reason</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">by_reason</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">By depth:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">by_depth</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Depth </span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">by_depth</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, YGO-Combo-Pipeline Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>